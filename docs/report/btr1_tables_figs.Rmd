---

pagetitle: "2024 Biennial Transparency Report Projections Chapter: Tables & Figures"
output:
  html_document:

---



```{r}
source('packages.R')
library(targets)
library(tarchetypes)
tar_source()

```

```{r}
tar_load(c(projections_all_sm, config))

```

```{r}
create_summary_table <- function(category, grouping, projections_all_sm, config) {
  
  col_order <- c('category','year','low','high')
  
  summary <- projections_all_sm %>%
    filter(!gas == 'Total') %>%  # WTH?? fix pls usproj
    rename(category = .data[[category]]) %>% 
    filter(grouping == grouping) %>%
    filter(year %in% config$table) %>% 
    group_by(proj_name,category, year) %>%
    summarise(cat_sum = sum(sum))
  
  summary_total_gross <- summary %>%
    filter(!category == 'LULUCF Sink') %>%
    group_by(proj_name, year) %>%
    summarise(value = sum(cat_sum)) %>%
    group_by(year) %>%
    mutate(low = min(value),
           high = max(value)) %>% 
    select(year,low,high) %>% 
    distinct() %>%
    mutate(category = 'Total Gross Emissions') %>% 
    select(all_of(col_order))
  
  
  summary_total_net <- summary %>%
    group_by(proj_name, year) %>%
    summarise(value = sum(cat_sum)) %>%
    group_by(year) %>%
    mutate(low = min(value),
           high = max(value)) %>%
    select(year,low,high) %>% 
    distinct() %>%
    mutate(category = 'Total Net Emissions')
  
  
  
  if(category == 'gas'){
    processed_datasets <- list()
    for(gas in config$gas_order){
      
      cat_summary <- summary %>%
        filter(category == gas) %>%
        group_by(proj_name, year) %>%
        summarise(value = sum(cat_sum)) %>%
        group_by(year) %>%
        mutate(low = min(value),
               high = max(value)) %>%
        select(year, low, high) %>%
        distinct() %>%
        mutate(category = gas) %>% 
        select(all_of(col_order))
      
      processed_datasets[[gas]] <- cat_summary
    }
    summary_table_df <- bind_rows(processed_datasets)
  }
  else if(category == 'usproj_sector'){
    processed_datasets <- list()
    for(sector in config$sector_order){
      
      cat_summary <- summary %>%
        filter(category == sector) %>%
        group_by(proj_name, year) %>%
        summarise(value = sum(cat_sum)) %>%
        group_by(year) %>%
        mutate(low = min(value),
               high = max(value)) %>%
        select(year, low, high) %>%
        distinct() %>%
        mutate(category = sector) %>% 
        select(all_of(col_order))
      
      processed_datasets[[sector]] <- cat_summary
    }
    summary_table_df <- bind_rows(processed_datasets)
  }
  else rlang::abort('Enter "gas" or "usproj_sector" into function.')

#tbl_historic <- gas_summary %>% filter(year %in% config$table) %>% pivot_wider(names_from = "year", values_from = "gas_sum")
  
}


```



