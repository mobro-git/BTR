---
title: "BTR Results Overview"
output:
  html_document:
    keep_md: true
    toc: yes
    toc_float:
      toc_collapsed: true
    toc_depth: 3
    theme: spacelab
date: "`r Sys.time()`"
---

```{r,echo = FALSE, results = "show", warning = FALSE, message = FALSE, error = FALSE}
knitr::opts_chunk$set(echo = FALSE, results = "show", warning = FALSE, message = FALSE, error = FALSE, 
                      fig.align = "center", fig.width = 9, fig.height = 5)
```


```{r}
library(targets)
library(tarchetypes)
tar_source()
```

```{r}
tar_load(config)
tar_load(settings)
tar_load(data_long_clean)
tar_load(figmap_nrgco2_stackbar)
tar_load(figmap_nrgco2_timeseries)
tar_load(figmap_nrgco2_diffbar)
tar_load(figmap_draftbriefing_stackbar)
```

```{r}
source('packages.R')
source("scripts/theming.R")
```


```{r}
# Dataframes for Statistics

tar_load(c(total_gross_emissions,
         total_net_emissions))
```

# Emissions

## Energy CO2 Emissions {.tabset}

### Sector

```{r}
sector = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 19, "United States", scenario_rename = TRUE)
sector
```

```{r}
get_figure_subset_df <- function(figmap_df, fig_num) {
  figure_subset_df <- figmap_df %>%
    filter(figure_no == fig_num)
}

get_data_long_clean_sums <- function(data_long_clean, var_list,config){
  
  df <- data_long_clean %>%
    filter(variable %in% var_list) %>%
    filter(scenario == 'wm') %>%
    filter(region == 'United States') %>%
    group_by(model,year) %>%
    summarise(value = sum(value), .groups = 'drop') %>%
    filter(year %in% config$fives_sumtab)
  
  df
}

get_range_max <- function(data_long_clean_sums){
  values2020 <- data_long_clean_sums %>% filter(year == 2020)
  values2040 <- data_long_clean_sums %>% filter(year == 2040)
  range_max <- round((1-min(values2040$value)/max(values2020$value))*100)
  range_max
}

get_range_min <- function(data_long_clean_sums){
  values2020 <- data_long_clean_sums %>% filter(year == 2020)
  values2040 <- data_long_clean_sums %>% filter(year == 2040)
  range_min <- round((1-max(values2040$value)/min(values2020$value))*100)
  range_min
}
```

```{r}
figure_subset_df <- get_figure_subset_df(figmap_nrgco2_stackbar,19)
var_list <- unique(figure_subset_df$variable)
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
nrgco2_max <- get_range_max(data_long_clean_sums)
nrgco2_min <- get_range_min(data_long_clean_sums)

figure_subset_df <- get_figure_subset_df(figmap_nrgco2_timeseries,9)
var_list <- c("Emissions|CO2|Energy|Demand|Buildings")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
buildings_max <- get_range_max(data_long_clean_sums)
buildings_min <- get_range_min(data_long_clean_sums)

figure_subset_df <- get_figure_subset_df(figmap_nrgco2_timeseries,9)
var_list <- c("Emissions|CO2|Energy|Demand|Industry")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
industry_max <- get_range_max(data_long_clean_sums)
industry_min <- get_range_min(data_long_clean_sums)

figure_subset_df <- get_figure_subset_df(figmap_nrgco2_timeseries,9)
var_list <- c("Emissions|CO2|Energy|Demand|Transportation")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
trn_max <- get_range_max(data_long_clean_sums)
trn_min <- get_range_min(data_long_clean_sums)


```


In the "With Measures" scenarios, Energy CO~2~ emissions decrease ranges from `r nrgco2_min`% to `r nrgco2_max`% from 2020 to 2040.



### Model

```{r}
model = print_graph("time_series", config, data_long_clean, figmap_nrgco2_timeseries, 9, "United States", scenario_rename = TRUE,
            level_var = c("Buildings", "Industry", "Transportation", "Supply", "Total Energy"))
model
```

By sector, the following decrease ranges are estimated:

- Buildings: `r buildings_min`% to `r buildings_max`%
- Industry: `r industry_min`% to `r industry_max`%
- Transportation: `r trn_min`% to `r trn_max`%

# Energy Consumption

## Final Energy {.tabset}

### Fuel
```{r}
fuel = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 14, "United States", scenario_rename = TRUE)
fuel
```
```{r}
figure_subset_df <- get_figure_subset_df(figmap_nrgco2_stackbar,14)
var_list <- unique(figure_subset_df$variable)
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
finalnrg_max <- get_range_max(data_long_clean_sums)
finalnrg_min <- get_range_min(data_long_clean_sums)
```

```{r}
var_list <- c("Final Energy|Biogas")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
biogas_max <- get_range_max(data_long_clean_sums)
biogas_min <- get_range_min(data_long_clean_sums)

var_list <- c("Final Energy|Biomass Liquids")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
biomass_liquids_max <- get_range_max(data_long_clean_sums)
biomass_liquids_min <- get_range_min(data_long_clean_sums)

var_list <- c("Final Energy|Coal")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
coal_max <- get_range_max(data_long_clean_sums)
coal_min <- get_range_min(data_long_clean_sums)

var_list <- c("Final Energy|Electricity")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
elec_max <- get_range_max(data_long_clean_sums)
elec_min <- get_range_min(data_long_clean_sums)

var_list <- c("Final Energy|Gas")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
gas_max <- get_range_max(data_long_clean_sums)
gas_min <- get_range_min(data_long_clean_sums)

var_list <- c("Final Energy|Hydrogen")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
h2_max <- get_range_max(data_long_clean_sums)
h2_min <- get_range_min(data_long_clean_sums)

var_list <- c("Final Energy|Oil")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
oil_max <- get_range_max(data_long_clean_sums)
oil_min <- get_range_min(data_long_clean_sums)

```

Overall, change in final energy consumption is estimated to range from `r finalnrg_min`% to `r finalnrg_max`% from 2020 to 2040.

By fuel-type, the following changes in energy consumption are estimated from 2020 to 2040:

- Biogas: `r biogas_min`% to `r biogas_max`%
- Biomass Liquids: `r biomass_liquids_min`% to `r biomass_liquids_max`%
- Coal: `r coal_min`% to `r coal_max`%
- Electricity: `r elec_min`% to `r elec_max`%
- Gas: `r gas_min`% to `r gas_max`%
- Hydrogen: `r h2_min`% to `r h2_max`%
- Oil: `r oil_min`% to `r oil_max`%

### Sector
```{r}
sector = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 17, "United States", scenario_rename = TRUE)
sector
```
```{r}
figure_subset_df <- get_figure_subset_df(figmap_nrgco2_stackbar,17)
var_list <- c("Final Energy|Buildings")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
fe_buildings_max <- get_range_max(data_long_clean_sums)
fe_buildings_min <- get_range_min(data_long_clean_sums)

var_list <- c("Final Energy|Industry")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
fe_industry_max <- get_range_max(data_long_clean_sums)
fe_industry_min <- get_range_min(data_long_clean_sums)

var_list <- c("Final Energy|Transportation")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
fe_trn_max <- get_range_max(data_long_clean_sums)
fe_trn_min <- get_range_min(data_long_clean_sums)
```


By sector, the following changes in energy consumption are estimated from 2020 to 2040:

- Buildings: `r fe_buildings_min`% to `r fe_buildings_max`%
- Industry: `r fe_industry_min`% to `r fe_industry_max`%
- Transportation: `r fe_trn_min`% to `r fe_trn_max`%

## Final Energy by Model {.tabset}

### Sector
```{r}
Sector = print_graph("time_series", config, data_long_clean, figmap_nrgco2_timeseries, 2, "United States", scenario_rename = TRUE)
Sector
```

### Fuel
```{r}
Fuel = print_graph("time_series", config, data_long_clean, figmap_nrgco2_timeseries, 1, "United States", scenario_rename = TRUE)
Fuel
```


## Final Energy by Sector {.tabset}

### Buildings
```{r}
Buildings = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 8, "United States", scenario_rename = TRUE)
Buildings
```

### Industry
```{r}
Industry = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 9, "United States", scenario_rename = TRUE)
Industry
```

### Transportation
```{r}
Transportation = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 12, "United States", scenario_rename = TRUE)
Transportation
```

# Energy Production

## Secondary Energy {.tabset}

### Fuel
```{r}
Fuel = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 15, "United States", scenario_rename = TRUE)
Fuel
```

### Model
```{r}
Model = print_graph("time_series", config, data_long_clean, figmap_nrgco2_timeseries, 8, "United States", scenario_rename = TRUE)
Model
```

## Electricity Production {.tabset}

### Generation
```{r}
elec_gen = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 13, "United States", scenario_rename = TRUE)
elec_gen
```
```{r}
figure_subset_df <- get_figure_subset_df(figmap_nrgco2_stackbar,13)

var_list <- c("Secondary Energy|Electricity|Biomass")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
se_biomass_max <- get_range_max(data_long_clean_sums)
se_biomass_min <- get_range_min(data_long_clean_sums)

var_list <- c("Secondary Energy|Electricity|Biomass")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
se_biomass_max <- get_range_max(data_long_clean_sums)
se_biomass_min <- get_range_min(data_long_clean_sums)

var_list <- c("Secondary Energy|Electricity|Biomass")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
se_biomass_max <- get_range_max(data_long_clean_sums)
se_biomass_min <- get_range_min(data_long_clean_sums)

var_list <- c("Secondary Energy|Electricity|Biomass")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
se_biomass_max <- get_range_max(data_long_clean_sums)
se_biomass_min <- get_range_min(data_long_clean_sums)

var_list <- c("Secondary Energy|Electricity|Biomass")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
se_biomass_max <- get_range_max(data_long_clean_sums)
se_biomass_min <- get_range_min(data_long_clean_sums)

var_list <- c("Secondary Energy|Electricity|Biomass")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
se_biomass_max <- get_range_max(data_long_clean_sums)
se_biomass_min <- get_range_min(data_long_clean_sums)

var_list <- c("Secondary Energy|Electricity|Biomass")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
se_biomass_max <- get_range_max(data_long_clean_sums)
se_biomass_min <- get_range_min(data_long_clean_sums)

var_list <- c("Secondary Energy|Electricity|Biomass")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
se_biomass_max <- get_range_max(data_long_clean_sums)
se_biomass_min <- get_range_min(data_long_clean_sums)

var_list <- c("Secondary Energy|Electricity|Biomass")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
se_biomass_max <- get_range_max(data_long_clean_sums)
se_biomass_min <- get_range_min(data_long_clean_sums)

var_list <- c("Secondary Energy|Electricity|Biomass")
data_long_clean_sums <- get_data_long_clean_sums(data_long_clean, var_list,config)
se_biomass_max <- get_range_max(data_long_clean_sums)
se_biomass_min <- get_range_min(data_long_clean_sums)
```


### Capacity
```{r}
Capacity = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 3, "United States", scenario_rename = TRUE)
Capacity
```



## Electricity Production - Combustion {.tabset}

### Generation
```{r}
elec_gen = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 6, "United States", scenario_rename = TRUE)
elec_gen
```


### Capacity
```{r}
Capacity = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 4, "United States", scenario_rename = TRUE)
Capacity
```



## Electricity Production - Non-Combustion {.tabset}

### Generation
```{r}
elec_gen = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 7, "United States", scenario_rename = TRUE)
elec_gen
```


### Capacity
```{r}
Capacity = print_graph("stacked_bar", config, data_long_clean, figmap_nrgco2_stackbar, 5, "United States", scenario_rename = TRUE)
Capacity
```

---

# BTR Tables and Figures

```{r}
tar_load(c(projections_all_sm, config))
```

## Value Summary Tables {.tabset}

```{r create df}
gas_df <- create_summary_table('gas','wm', projections_all_sm, config)
sector_df <- create_summary_table('usproj_sector', 'wm', projections_all_sm, config)
```

### Gas
```{r gas summary}
gas_table <- create_html_table(gas_df, 'Gas',config)
gas_table
```


```{r}
filename <- paste0("gas_table_",Sys.Date(),".png")
gtsave(gas_table, paste0('output/',settings$version,"/tables_figs/results_tables/estimated_values/",filename))

```

### Sector
```{r sector summary}
sector_table <- create_html_table(sector_df, 'Sector',config)
sector_table
```

```{r}

filename <- paste0("sector_table_",Sys.Date(),".png")
gtsave(sector_table, paste0('output/',settings$version,"/tables_figs/results_tables/estimated_values/",filename))
```

## 2005 Percent Change Table {.tabset}

### Gas
```{r, pct change by gas}
pct_change_table_gas <- create_pct_change_table('gas', 'wm', projections_all_sm, config)
pct_change_html_gas <- create_pct_change_html_table(pct_change_table_gas, 'Gas', config)
pct_change_html_gas
```


```{r}

filename <- paste0("gas_table_pctchange05_",Sys.Date(),".png")
gtsave(pct_change_html_gas, paste0('output/',settings$version,"/tables_figs/results_tables/percent_change_2005/",filename))
```

### Sector
```{r, pct change by sector}
pct_change_table_sector <- create_pct_change_table('usproj_sector', 'wm', projections_all_sm, config)
pct_change_html_sector <- create_pct_change_html_table(pct_change_table_sector, 'Sector', config)
pct_change_html_sector
```


```{r}

filename <- paste0("sector_table_pctchange05_",Sys.Date(),".png")
gtsave(pct_change_html_sector, paste0('output/',settings$version,"/tables_figs/results_tables/percent_change_2005/",filename))
```

## BTR Main Plot {.tabset}

```{r data}
net_ghg = projections_all_sm %>%
  group_by(proj_name, grouping, year) %>%
  summarise(sum = sum(sum)) %>%
  filter(year %in% config$fives)

ghgi = net_ghg %>% filter(proj_name == "ghgi")
proj_no_connect = net_ghg %>% 
  filter(proj_name != "ghgi")

connect = ghgi[ghgi$year == 2022,]$sum
baseline = ghgi[ghgi$year == 2005,]$sum

proj_connect = proj_no_connect %>% 
  group_by(proj_name) %>%
  slice(1) %>%
  mutate(
    year = 2022,
    sum = ghgi$sum[ghgi$year == 2022])

proj = rbind(proj_no_connect, proj_connect) %>%
  mutate(year = as.numeric(year))

ndc_targets = data.frame(
  year = c(2020, 2025, 2030),
  ymin = c((baseline * (1-.169)), (baseline * (1-.26)), (baseline * (1-.50))),
  ymax = c((baseline * (1-.171)), (baseline * (1-.28)), (baseline * (1-.52))),
  grouping = c("17% Below 2005","26-28% Below 2005","50-52% Below 2005")
)
```

### Net GHG Emissions
```{r proj function}
projections = br_project(ghgi, proj, config, targets = ndc_targets)
projections

#TODO: create a new figure that graphs the % reduction from 2005 instead of the objective values - both for historical emissions AND projections
```

```{r}
filename <- paste0("btr_main_fig_",Sys.Date(),".png")
ggsave(paste0('output/',settings$version,"/tables_figs/btr_main_fig/",filename))

```


```{r}

net_ghg = projections_all_sm %>%
  group_by(proj_name, grouping, year) %>%
  summarise(sum = sum(sum),.groups = 'drop') %>%
  filter(year %in% config$fives) %>%
  mutate(pct_change_05 = round((sum/sum[year==2005]-1),2))


ghgi = net_ghg %>% filter(proj_name == "ghgi")
proj_no_connect = net_ghg %>% 
  filter(proj_name != "ghgi")

connect = ghgi[ghgi$year == 2022,]$pct_change_05
baseline = ghgi[ghgi$year == 2005,]$pct_change_05

proj_connect = proj_no_connect %>% 
  group_by(proj_name) %>%
  slice(1) %>%
  mutate(
    year = 2022,
    pct_change_05 = ghgi$pct_change_05[ghgi$year == 2022])

proj = rbind(proj_no_connect, proj_connect) %>%
  mutate(year = as.numeric(year))

ndc_targets = data.frame(
  year = c(2020, 2025, 2030),
  ymin = c(-.17, -.28, -.52),
  ymax = c(-.17, -.26, -.5),
  grouping = c("17% Below 2005","26-28% Below 2005","50-52% Below 2005")
)




```

### Percent Change from 2005

```{r}
projections_pct_change = br_project_pct_change(ghgi, proj, targets = ndc_targets)
projections_pct_change
```

```{r}
filename <- paste0("btr_main_fig_pctchange05_",Sys.Date(),".png")
ggsave(paste0('output/',settings$version,"/tables_figs/btr_main_fig/",filename))

```


## BTR Net-GHG Stackbar

```{r}

proj_all_sm_sb <- projections_all_sm %>%
  mutate(gas = case_when(gas %in% c("CO2") ~ "CO2",
                         !gas %in% c("CO2", 'LULUCF Sink') ~ "Non-CO2",
                         gas %in% c("LULUCF Sink") ~ "LULUCF Sink")) %>%
  group_by(proj_name,year,gas) %>%
  summarise(mmtco2e = sum(sum), .groups = 'drop') %>%
  filter(year >= config$base_year) %>%
  filter(year %in% config$base_proj)

no_ghgi <- proj_all_sm_sb %>% filter(!proj_name == 'ghgi')

ghgi <- proj_all_sm_sb %>% filter(proj_name == 'ghgi')

dfs <- list()

for(name in unique(no_ghgi$proj_name)) {
  df <- proj_all_sm_sb %>% filter(proj_name == name)
  add_ghgi <- ghgi %>%
    rbind(df) %>%
    mutate(proj_name = name)
  
  dfs[[name]] <- add_ghgi

}

proj_all_sm_sb_final <- bind_rows(dfs)

net_co2_df <- proj_all_sm_sb_final %>%
  group_by(proj_name, year) %>%
  summarise(net_co2 = sum(mmtco2e), .groups = 'drop')

proj_all_sm_sb_join <- proj_all_sm_sb_final %>%
  left_join(net_co2_df, by = c('proj_name','year')) %>%
  mutate(year = as.factor(year)) %>%
  mutate(gas = factor(gas, levels = c('CO2','Non-CO2','LULUCF Sink')))


fills <- c("CO2" =  "#0388B3",
           "Non-CO2" = "#E6544D",
           "LULUCF Sink" = "#16B231")
  

```

```{r}
proj_all_stackbar <- br_project_sb(proj_all_sm_sb_join, config, fills)
proj_all_stackbar

```