---
pagetitle: "2024 Biennial Transparency Report Projections Chapter: Historical and Projected GHG Tables & Figures"
output:
  html_document:
    number_sections: false
    highlight: tango
    fontsize: 12
    fig_caption: false
    toc: yes
    toc_float:
      toc_collapsed: true
    toc_depth: 3
    theme: spacelab
params:
  mode: "interactive"
---

```{r,echo = FALSE, results = "show", warning = FALSE, message = FALSE, error = FALSE}
knitr::opts_chunk$set(echo = FALSE, results = "show", warning = FALSE, message = FALSE, error = FALSE, fig.align = "center", fig.width = 9, fig.height = 7)


``` 

```{r}
source('packages.R')
library(targets)
library(tarchetypes)
tar_source()
source("scripts/theming.R")

```

```{r}

tar_load(
  c(
    config,
    settings,
    data_long_clean,
    projections_all_sm,
    total_gross_emissions,
    ghgi_comp_tab,
    projections_ghgi,
    past_proj,
    kaya_comparison50
    )
  )

projections_all_sm <- projections_all_sm %>%
  mutate(grouping = case_when(grouping == "wm" ~ "wm_sens",
                              TRUE~grouping))
  


```

# BTR Tables and Figures: BRVS & BTR Sensitivities Comparison

## Value Summary Tables {.tabset}

### Gas

```{r gas summary}
gas_df <- create_summary_table('gas','wm_sens', projections_all_sm, config, settings)
gas_table <- create_html_table(gas_df, 'Gas', settings)
gas_table_merged <- create_html_table_merged(gas_df, 'Gas', settings)

gas_table_merged
```


### Sector

```{r sector summary}
sector_df <- create_summary_table('usproj_sector', 'wm_sens', projections_all_sm, config, settings)
sector_table <- create_html_table(sector_df, 'Sector', settings)
sector_table_merged <- create_html_table_merged(sector_df, 'Sector', settings)

sector_table_merged
```

### % Change: Gas

```{r, pct change by gas}
pct_change_table_gas <- create_pct_change_table('gas', 'wm_sens', projections_all_sm, config, settings)
pct_change_html_gas_merged <- create_html_table_merged_pct_change(pct_change_table_gas, 'Gas', settings)

pct_change_html_gas_merged
```

### % Change: Sector

```{r, pct change by sector}
pct_change_table_sector <- create_pct_change_table('usproj_sector', 'wm_sens', projections_all_sm, config, settings)
pct_change_html_sector_merged <- create_html_table_merged_pct_change(pct_change_table_sector, 'Sector', settings)

pct_change_html_sector_merged
```

## Net-GHG Emissions {.tabset}

### BR:VS - BTR Model Subset

```{r}
brvs_tne <- read_csv("data-extra/BR Voluntary Supplement 2023/brvs_totalnetemissions.csv")

```


```{r}
fig <- br_project_brvs_sens(projections_ghgi, brvs_tne, config, settings, brvs_btr_subset = TRUE)

fig
```

```{r}
filename <- paste0("btr_main_fig_",Sys.Date(),".png")
ggsave(paste0('output/',settings$version,"/tables_figs_sens/btr_main_figs/main_fig/",filename), create.dir = TRUE, height = 7, width = 9)
```

### BR:VS - All Models

```{r}
fig <- br_project_brvs_sens(projections_ghgi, brvs_tne, config, settings, brvs_btr_subset = FALSE)

fig
```


### No BR:VS

```{r}
fig <- br_project_sens(projections_ghgi, config, settings)

fig

```

```{r}
filename <- paste0("btr_main_fig_nobrvs_",Sys.Date(),".png")
ggsave(paste0('output/',settings$version,"/tables_figs_sens/btr_main_figs/main_fig/",filename), create.dir = TRUE)
```

## Value Summary Tables

### 


## Kaya BR5:VS Comparison

```{r}
kaya_fig <- kaya_brvs(kaya_comparison50, data_long_clean, config, settings)
kaya_fig
```

```{r}
ggsave(paste0('output/',settings$version,"/tables_figs_sens/kaya/kaya_singlepanel.png"), width = 5, create.dir = TRUE)

```


## GDP-Breakout, BR5:VS Comparison

```{r}
fig <- gdp_breakout(data_long_clean, config)

fig
```


# Sector Analysis {.tabset}

## Buildings {.tabset}

### All Models

```{r}
brvs_sectors <- read_csv("data-extra/BR Voluntary Supplement 2023/brvs_sectors.csv")
```


```{r}
buildings <- brvs_sens_sectors("Emissions|CO2|Energy|Demand|Buildings|Total", brvs_btr_subset = FALSE, brvs_sectors, ghgi_comp_tab, config, settings, data_long_clean)

buildings
```

### BTR Subset

```{r}
buildings <- brvs_sens_sectors("Emissions|CO2|Energy|Demand|Buildings|Total", brvs_btr_subset = TRUE, brvs_sectors, ghgi_comp_tab, config, settings,data_long_clean)

buildings
```

## Electricity {.tabset}

### All Models

```{r}
electricity <- brvs_sens_sectors("Emissions|CO2|Energy|Supply|Electricity", brvs_btr_subset = FALSE, brvs_sectors, ghgi_comp_tab, config, settings,data_long_clean)

electricity
```

### BTR Subset

```{r}
electricity <- brvs_sens_sectors("Emissions|CO2|Energy|Supply|Electricity", brvs_btr_subset = TRUE, brvs_sectors, ghgi_comp_tab, config, settings,data_long_clean)

electricity
```

## Transportation {.tabset}

### All Models

```{r}
transportation <- brvs_sens_sectors("Emissions|CO2|Energy|Demand|Transportation|Total", brvs_btr_subset = FALSE, brvs_sectors, ghgi_comp_tab, config, settings,data_long_clean)

transportation
```

### BTR Subset

```{r}
transportation <- brvs_sens_sectors("Emissions|CO2|Energy|Demand|Transportation|Total", brvs_btr_subset = TRUE, brvs_sectors, ghgi_comp_tab, config, settings,data_long_clean)

transportation
```

## Industry {.tabset}

### All Models

```{r}
industry <- brvs_sens_sectors("Emissions|CO2|Energy|Demand|Industry and Fuel Production|Total", brvs_btr_subset = FALSE, brvs_sectors, ghgi_comp_tab, config, settings,data_long_clean)

industry
```

### BTR Subset

```{r}
industry <- brvs_sens_sectors("Emissions|CO2|Energy|Demand|Industry and Fuel Production|Total", brvs_btr_subset = TRUE, brvs_sectors, ghgi_comp_tab, config, settings,data_long_clean)

industry
```

# Electricity and Transportation CO2

# Energy and Transportation CO2 Emissions Range {.tabset}

## Figure

```{r}
nrg_emissions <- projections_all_sm %>%
  filter(usproj_sector %in% c('Energy','Transportation') & gas == "CO2") %>%
  filter(grouping %in% c('ghgi','wm_sens')) %>%
  group_by(proj_name, year, grouping) %>%
  summarise(nrg_trn_co2 = sum(sum)) %>%
  filter(year %in% config$annual_1990_fives) 

ghgi <- nrg_emissions %>%
  filter(year <= settings$base_year)

proj <- nrg_emissions %>%
  group_by(year) %>% 
  filter(year >= settings$base_year)%>%
    summarise(ymax = max(nrg_trn_co2),
              ymin = min(nrg_trn_co2),
              med = median(nrg_trn_co2),
              .groups = 'drop')

nrg_color <- "#2EAD96"

fig <- 
  ggplot() +
  geom_line(ghgi, mapping = aes(x = year, y = nrg_trn_co2, color = proj_name), color = nrg_color, size = 0.7) +
  geom_ribbon(proj, mapping = aes(x = year,ymax = ymax, ymin = ymin),
              color = nrg_color,
              fill = nrg_color,
              alpha = 0.4 ,
              size = 0.7)+
    labs(x = 'Year',
         y = expression(paste("MMt ", CO[2], sep = ""))) +
    geom_vline(
      xintercept = 2022,
      linetype = 'dashed',
      color = "black",
      # size = 0.4,
      alpha = 0.5) +
    scale_y_continuous(labels = scales::comma) +
    scale_x_continuous(breaks = c(seq(1990,2020,by=5), 2022, seq(2025,2040,by=5)), expand = c(0,0)) +
    theme_btr() 
  
fig
```

```{r}
filename <- paste0("nrg_emissions_fig_",Sys.Date(),".png")
ggsave(paste0('output/',settings$version,"/tables_figs_sens/nrg_emissions/",filename), create.dir = TRUE,height = 4.5)
```

# NCBR Comp

```{r}

past_proj_clean <- past_proj %>%
  select(Report, Year, Emissions) %>%
  rename(Value = Emissions) %>%
  filter(Year <= 2035)


tge_btr <- projections_all_sm %>% 
  filter(!gas == 'LULUCF Sink',
         grouping %in% c('wm_sens','ghgi')) %>%
  group_by(proj_name, grouping, year) %>%
  summarise(Value = sum(sum),.groups = 'drop')

tge_all_long <- tge_btr %>%
  mutate(Report = 'btr_2024') %>%
  rename(Year = year) %>% 
  select(names(past_proj_clean)) %>%
  rbind(past_proj_clean) %>%
  mutate(Year = as.numeric(Year),
         Report = case_when(Report == "btr_2024" ~ "2024 BTR",
                            Report == "car_2014" ~ "2014 CAR",
                            Report == "br_2016" ~ "2016 BR",
                            Report == "br_2021" ~ "2021 BR",
                            Report == "br_2022" ~ "2022 BR"))
#%>%
 # filter(year %in% config$fives_proj_sm)


ncbr_comp_ribbon <- tge_all_long %>% 
  group_by(Report,Year) %>%
  mutate(min = min(Value),
         max = max(Value)) %>%
  select(Report,Year,min,max) %>%
  distinct()
```

```{r}
fig <- ncbr_comparison_figure_sens(ncbr_comp_ribbon, tge_all_long, settings, config)

fig
```

```{r}
filename <- paste0("ncbr_comp_fig_",Sys.Date(),".png")
ggsave(paste0('output/',settings$version,"/tables_figs_sens/ncbr_comparison/",filename), create.dir = TRUE)
```