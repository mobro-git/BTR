---
pagetitle: "2024 Biennial Transparency Report Projections Chapter: Historical and Projected GHG Tables & Figures"
output:
  html_document:
    number_sections: false
    highlight: tango
    fontsize: 12
    fig_caption: false
params:
  mode: "interactive"
---

```{r,echo = FALSE, results = "show", warning = FALSE, message = FALSE, error = FALSE}
knitr::opts_chunk$set(echo = FALSE, results = "show", warning = FALSE, message = FALSE, error = FALSE, fig.align = "center", fig.width = 9, fig.height = 7)

```

```{r}
source('packages.R')
source("scripts/theming.R")
library(targets)
library(tarchetypes)
tar_source()
```

```{r}
tar_load(
  c(
    config,
    settings,
    data_long_clean,
    projections_all_sm,
    figmap_nrgco2_stackbar,
    figmap_nrgco2_timeseries,
    figmap_nrgco2_diffbar,
    ghgi_comp_tab,
    total_gross_emissions
    )
  )
```

# TOC to fill out

✓ Figure 1 US Net GHG Emissions Projections 
✓ Table 1 Historical and Projected GHG Emissions by gas 
✓ Table 2 Historical and Projected GHG Emissions by sector
- Figure 2 Current Measures CO2 Projections for Forestry and Land Use
- Table 3 Comparison of Total Gross GHG Emissions under Policy Baseline Projections to Previous US Climate Action and Biennial Reports (data-raw/ncbr_comparison/total_gross_ghg_ncbr_comparisons.csv)
- Figure 3 Comparison of 2024 "With Measures" Baseline to Previous "With Measures" Projections (data-raw/ncbr_comparison/total_gross_ghg_ncbr_comparisons.csv)
- Figure 4 Comparison of Energy-Related CO2 Projections "With Measures" Baseline range to Previous AEO projections (still need to pull data for this)
- Figure 5 Normalized Kaya Identity Factors Used for Assessing the Effects of New Policies and Measures (data-raw/ncbr_comparison/kaya_check_usproj_br5_ar4.xlsx)
- Table 4 Estimates of the Total Effect of New Policies and Measures and Technological Change (Morgan to figure out breakouts)
- Sectoral CO2 emissions figures comparing BTR1 projections to LTS


### Figures to add

1) total gross ghg emissions comparison figure - add range of gross ghg for BTR1 - 
2) 

# BTR Tables and Figures

## Value Summary Tables {.tabset}

### Gas

```{r gas summary}
gas_df <- create_summary_table('gas','wm', projections_all_sm, config)

gas_table <- create_html_table(gas_df, 'Gas',config)

gas_table_merged <- create_html_table_merged(gas_df, 'Gas', config)
gas_table_merged
```

```{r}
filename <- paste0("gas_table_",Sys.Date(),".png")
gtsave(gas_table_merged, paste0('output/',settings$version,"/tables_figs/results_tables/estimated_values/",filename))
```

### Sector

```{r sector summary}
sector_df <- create_summary_table('usproj_sector', 'wm', projections_all_sm, config)

sector_table <- create_html_table(sector_df, 'Sector',config)

sector_table_merged <- create_html_table_merged(sector_df, 'Sector', config)
sector_table_merged
```

```{r}

filename <- paste0("sector_table_",Sys.Date(),".png")
gtsave(sector_table_merged, paste0('output/',settings$version,"/tables_figs/results_tables/estimated_values/",filename))
```

## 2005 Percent Change Table {.tabset}

### Gas

```{r, pct change by gas}
pct_change_table_gas <- create_pct_change_table('gas', 'wm', projections_all_sm, config)
pct_change_html_gas <- create_pct_change_html_table(pct_change_table_gas, 'Gas', config)
pct_change_html_gas
```

```{r}

filename <- paste0("gas_table_pctchange05_",Sys.Date(),".png")
gtsave(pct_change_html_gas, paste0('output/',settings$version,"/tables_figs/results_tables/percent_change_2005/",filename))
```

### Sector

```{r, pct change by sector}
pct_change_table_sector <- create_pct_change_table('usproj_sector', 'wm', projections_all_sm, config)
pct_change_html_sector <- create_pct_change_html_table(pct_change_table_sector, 'Sector', config)
pct_change_html_sector
```

```{r}

filename <- paste0("sector_table_pctchange05_",Sys.Date(),".png")
gtsave(pct_change_html_sector, paste0('output/',settings$version,"/tables_figs/results_tables/percent_change_2005/",filename))
```

## BTR Main Plot {.tabset}

```{r data}
net_ghg = projections_all_sm %>%
  group_by(proj_name, grouping, year) %>%
  summarise(sum = sum(sum)) %>%
  filter(year %in% config$fives)

ghgi = net_ghg %>% filter(proj_name == "ghgi")
proj_no_connect = net_ghg %>% 
  filter(proj_name != "ghgi")

connect = ghgi[ghgi$year == 2022,]$sum
baseline = ghgi[ghgi$year == 2005,]$sum

proj_connect = proj_no_connect %>% 
  group_by(proj_name) %>%
  slice(1) %>%
  mutate(
    year = 2022,
    sum = ghgi$sum[ghgi$year == 2022])

proj = rbind(proj_no_connect, proj_connect) %>%
  mutate(year = as.numeric(year))

ndc_targets = data.frame(
  year = c(2020, 2025, 2030),
  ymin = c((baseline * (1-.169)), (baseline * (1-.26)), (baseline * (1-.50))),
  ymax = c((baseline * (1-.171)), (baseline * (1-.28)), (baseline * (1-.52))),
  grouping = c("17% Below 2005","26-28% Below 2005","50-52% Below 2005")
)
```

### Net GHG Emissions

```{r proj function}
projections = br_project(ghgi, proj, config, targets = ndc_targets)
projections
```

```{r}
filename <- paste0("btr_main_fig_",Sys.Date(),".png")
ggsave(paste0('output/',settings$version,"/results_overview/btr_figs/",filename))
```

```{r}
net_ghg = projections_all_sm %>%
  group_by(proj_name, grouping, year) %>%
  summarise(sum = sum(sum),.groups = 'drop') %>%
  filter(year %in% config$fives) %>%
  mutate(pct_change_05 = round((sum/sum[year==2005]-1),2))


ghgi = net_ghg %>% filter(proj_name == "ghgi")
proj_no_connect = net_ghg %>% 
  filter(proj_name != "ghgi")

connect = ghgi[ghgi$year == 2022,]$pct_change_05
baseline = ghgi[ghgi$year == 2005,]$pct_change_05

proj_connect = proj_no_connect %>% 
  group_by(proj_name) %>%
  slice(1) %>%
  mutate(
    year = 2022,
    pct_change_05 = ghgi$pct_change_05[ghgi$year == 2022])

proj = rbind(proj_no_connect, proj_connect) %>%
  mutate(year = as.numeric(year))

ndc_targets = data.frame(
  year = c(2020, 2025, 2030),
  ymin = c(-.17, -.28, -.52),
  ymax = c(-.17, -.26, -.5),
  grouping = c("17% Below 2005","26-28% Below 2005","50-52% Below 2005")
)
```

### Percent Change from 2005

```{r}
projections_pct_change = br_project_pct_change(ghgi, proj, targets = ndc_targets)
projections_pct_change
```

```{r}
filename <- paste0("btr_main_fig_pctchange05_",Sys.Date(),".png")
ggsave(paste0('output/',settings$version,"/results_overview/btr_figs/",filename))
```

## BTR Net-GHG Stackbar

```{r, fig.width=15}
net_ghg_sb_df <- net_ghg_sb_data_processing(projections_all_sm, config)

net_ghg_stackbar <- br_project_net_ghg_sb(net_ghg_sb_df, config)

net_ghg_stackbar
```

# Kaya Analysis

```{r}
dat = data_long_clean |> 
  filter(variable %in% c("Emissions|CO2|Energy", "Final Energy", "GDP|MER", "Population")) |>
  select(-unit) |> 
  spread(variable, value) |> 
  mutate(EmissPerEnergy = `Emissions|CO2|Energy`/`Final Energy`,
         EnergyPerGDP = `Final Energy`/`GDP|MER`,
         GDPPerCap = `GDP|MER`/`Population`) 

dat2 = dat |> 
  filter(year == 2020) |> 
  select(-`Emissions|CO2|Energy`, -`Final Energy`, -`GDP|MER`) |> 
  rename(EmissPerEnergyBase = EmissPerEnergy,
         EnergyPerGDPBase = EnergyPerGDP,
         GDPPerCapBase = GDPPerCap,
         PopulationBase = Population) |> 
  select(-year)

dat3 = dat |> 
  left_join(dat2) |> 
  select(-`Emissions|CO2|Energy`, -`Final Energy`, -`GDP|MER`) |> 
  mutate(EmissPerEnergyIn = EmissPerEnergy/EmissPerEnergyBase,
         EnergyPerGDPIn = EnergyPerGDP/EnergyPerGDPBase,
         GDPPerCapIn = GDPPerCap/GDPPerCapBase,
         PopulationIn = Population/PopulationBase) |> 
  filter(region == "United States") |> 
  select(model,scenario,year,datasrc,region,EmissPerEnergyIn,EnergyPerGDPIn,GDPPerCapIn,PopulationIn) |> 
  pivot_longer(cols = 6:9, names_to = "var", values_to = "value")
```

```{r}
Kaya = function(dat3,mod,scen){
  dat3 |> 
    filter(model == mod & scenario == scen) |> 
    ggplot()+
    geom_line(aes(x=year, y =value, color = var))+
    theme_custom()
}

Kaya(dat3,"OP-NEMS","wm")
```

# Sector Analysis

## Figures {.tabset}

```{r}
sector_vars = c("Emissions|CO2|Energy|Demand|Buildings|Total",
                         "Emissions|CO2|Energy|Demand|Transportation|Total",
                         "Emissions|CO2|Energy|Demand|Industry and Fuel Production|Total",
                         "Emissions|CO2|Energy|Supply|Electricity")
lts_vars = c("Emissions|CO2|Energy|Demand|Buildings|TotalDI",
                         "Emissions|CO2|Energy|Demand|Transportation|TotalDI",
                         "Emissions|CO2|Energy|Demand|Industry|TotalDI",
                         "Emissions|CO2|Energy|Supply|Electricity")

# ghgi 24 data
ghgi_df = ghgi_comp_tab %>%
  filter(model == config$model_hist) %>%
  filter(year %in% config$hist) %>%
  filter(variable %in% sector_vars)

# LTS models and variables used for sector figures
lts_df = data_long_clean %>%
  filter(model %in% config$model_lts) %>%
  filter(year %in% config$fives_proj_sm) %>%
  filter(variable %in% lts_vars) %>%
  # change names to match template update variable names
  mutate(variable = case_when(
    str_detect(variable, "Buildings") ~ "Emissions|CO2|Energy|Demand|Buildings|Total",
    str_detect(variable, "Transportation") ~ "Emissions|CO2|Energy|Demand|Transportation|Total",
    str_detect(variable, "Industry") ~ "Emissions|CO2|Energy|Demand|Industry and Fuel Production|Total",
    TRUE~variable))

# models used in the projections and variables used for sector figures
proj_models = config$model_wm
proj_df = data_long_clean %>%
  filter(model %in% proj_models) %>%
  filter(year %in% config$fives_proj_sm) %>%
  filter(scenario == "wm") %>%
  filter(variable %in% sector_vars) %>%
  filter(region == 'United States')

# 2030 and 2035 projections medians
median_df = proj_df %>%
  group_by(year,variable) %>%
  summarise(value = median(value)) %>%
  mutate(model = "median",
         scenario = "wm",
         unit = "Mt CO2/yr",
         datasrc = "median calc",
         region = "United States") %>%
  select(names(proj_df))

# merge three datasets together
sector_df = rbind(ghgi_df, lts_df, proj_df, median_df) %>%
  mutate(type = case_when(
    str_detect(model, "LTS") ~ "LTS",
    model %in% proj_models ~ "proj",
    model == "EPA-GHGI" ~ "GHGI",
    model == "median" ~ "median",
    TRUE~model))
```

```{r}
# buildings
buildings = br_sectors(sector_df,
                       "Emissions|CO2|Energy|Demand|Buildings|Total",
                       expression(paste("Buildings Emissions (MMt C", O[2], ")")))

# electricity
# electricity = br_sectors(sector_df,
#                        "Emissions|CO2|Energy|Supply|Electricity",
#                        expression(paste("Electricity Emissions (MMt C", O[2], ")")))

# transportation
transportation = br_sectors(sector_df,
                       "Emissions|CO2|Energy|Demand|Transportation|Total",
                       expression(paste("Transportation Emissions (MMt C", O[2], ")")))

# industry
industry = br_sectors(sector_df,
                       "Emissions|CO2|Energy|Demand|Industry and Fuel Production|Total",
                       expression(paste("Industry Emissions (MMt C", O[2], ")")))
```

### Buildings

```{r}
buildings
```

### Electricity

```{r}
#electricity
```

### Transportation

```{r}
transportation
```

### Industry

```{r}
industry
```

## Table 3: NCBR Comparison

```{r}
# Load in past NCBR data
ncbr_comp_data_hist <- read_csv('data-raw/ncbr_comparison/total_gross_ghg_ncbr_comparisons.csv')

ncbr_data_hist_long <- ncbr_comp_data_hist %>% 
  pivot_longer(cols = 2:20, names_to = 'year')

# Pivot BTR total gross emissions long

tge_all_long <- total_gross_emissions %>%
  pivot_longer(cols = 3:11, names_to = 'year') %>%
  mutate(Projection = '2024 BTR') %>%
  select(names(ncbr_data_hist_long)) %>%
  distinct() %>%
  rbind(ncbr_data_hist_long) %>%
  mutate(year = as.numeric(year))
#%>%
 # filter(year %in% config$fives_proj_sm)

ncbr_comp_table_df <- tge_all_long %>% 
  pivot_wider(names_from = year,
              values_from = value)

ncbr_comp_table_df <- tge_all_long %>% 
  group_by(Projection,year) %>%
  mutate(min = min(value),
         max = max(value)) %>%
  select(Projection,year,min,max) %>%
  distinct()

# Isolate min and max values for proj years and rbind
# tge_long_min <- tge_long %>%
#   mutate(Projection = '2024 BTR Low') %>%
#   rename(value = min) %>% 
#   select(Projection,year,value) %>%
#   pivot_wider(names_from = year,
#               values_from = value)
# 
# tge_long_max <- tge_long %>%
#   mutate(Projection = '2024 BTR High') %>%
#   rename(value = max) %>% 
#   select(Projection,year,value) %>%
#   pivot_wider(names_from = year,
#               values_from = value)
# 
# btr_highlow_df <- tge_long_max %>% rbind(tge_long_min)

# Rbind past NCBRs with BTR
# tge_rbind <- btr_highlow_df %>%
#   bind_rows(ncbr_comp_data_hist) %>%
#   select(Projection, '2005','2010','2015','2020','2025','2030','2035','2040')
# 
# 
# ncbr_comp_table <- tge_rbind %>%
#   gt() %>% 
#   gt_theme_nc_blue()
# 
# ncbr_comp_table

```

## Figure: NCBR Comparison
TODO: Create another version with data back to 1990.
```{r}
fig <- ncbr_comparison_figure(ncbr_comp_data_hist, tge_all_long, config)
fig

```

## NCBR Comparision Figure: From 1990

```{r}
ncbr_90 <- read_csv("data-raw/ncbr_comparison/past_nc_br_comparison_data.csv")

tge_90 <- ncbr_90 %>% filter(category == 'GrossTotal',
                          gas == 'Total')

tge_90_long <- tge_90 %>% pivot_longer(cols = 8:53,
                                       names_to = 'year') %>%
  rename(Projection = publication) %>% 
  select(Projection,year,value) %>%
  mutate(year = as.numeric(year))

fig <- ncbr_comp_fig_1990(tge_90_long, tge_all_long, config)
fig

```

