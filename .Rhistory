final_summary_table
View(summary_table_df)
summary_table_df$category <- subscript_numbers(summary_table_df$category)
subscript_numbers <- function(string) {
gsub("([0-9]+)","<sub>\\1</sub>",string,perl = TRUE)
}
if(category == 'gas'){
order_index <- c(2,1,4,3,6,7,5) # added NF3
processed_datasets <- list()
for(gas in config$gas_order){
cat_summary <- summary %>%
filter(category == gas) %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum),.groups='drop') %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year, low, high) %>%
distinct() %>%
mutate(category = gas) %>%
select(all_of(col_order))
processed_datasets[[gas]] <- cat_summary
}
summary_table_df <- bind_rows(processed_datasets)
summary_table_df$category <- subscript_numbers(summary_table_df$category)
} else if(category == 'usproj_sector'){
processed_datasets <- list()
order_index <- c(2,4,3,1,5)
for(sector in config$sector_order){
cat_summary <- summary %>%
filter(category == sector) %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum),.groups='drop') %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year, low, high) %>%
distinct() %>%
mutate(category = sector) %>%
select(all_of(col_order))
processed_datasets[[sector]] <- cat_summary
}
summary_table_df <- bind_rows(processed_datasets)
summary_table_df$category <- ifelse(summary_table_df$category == 'IPPU', 'Industrial Processes', summary_table_df$category) # Change 'IPPU' to 'Industrial Processes'
}
summary_table_df
View(summary_table_df)
else{rlang::abort('Enter "gas" or "usproj_sector" into as category.')}
summary_table_df_high_low <- create_high_low_df(summary_table_df, config)
summary_table_df_high_low <- summary_table_df_high_low[order_index,]
total_gross_emissions_high_low <- create_high_low_df(summary_total_gross, config)
total_net_emissions_high_low <- create_high_low_df(summary_total_net, config)
summary_lulucf_sink <- summary %>% filter(category == 'LULUCF Sink')%>%
group_by(category,proj_name, year) %>%
summarise(value = sum(cat_sum),.groups='drop') %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(category, year, low, high) %>%
distinct()
lulucf_sink_high_low <- create_high_low_df(summary_lulucf_sink, config)
final_summary_table <- summary_table_df_high_low %>%
rbind(total_gross_emissions_high_low) %>%
rbind(lulucf_sink_high_low) %>%
rbind(total_net_emissions_high_low)
rownames(final_summary_table) <- NULL
final_summary_table <- final_summary_table %>% mutate_if(is.numeric, round)
numeric_cols <- sapply(final_summary_table,is.numeric)
final_summary_table[, numeric_cols] <- lapply(final_summary_table[, numeric_cols], scales::comma)
View(final_summary_table)
stubhead <- "Gas"
hist_years <- c('2005','2010','2015','2020', config$base_year)
proj_col_order <- c('2025_low',
'2025_high',
'2030_low',
'2030_high',
'2035_low',
'2035_high',
'2040_low',
'2040_high')
html_table <-  final_summary_table %>%
rename(!!stubhead := category) %>%
gt() %>%
tab_spanner(label = "2025", columns = proj_col_order[1:2]) %>%
tab_spanner(label = "2030", columns = proj_col_order[3:4]) %>%
tab_spanner(label = "2035", columns = proj_col_order[5:6]) %>%
tab_spanner(label = "2040", columns = proj_col_order[7:8]) %>%
cols_label(`2025_low` = 'Low') %>%
cols_label(`2030_low` = 'Low') %>%
cols_label(`2035_low` = 'Low') %>%
cols_label(`2040_low` = 'Low') %>%
cols_label(`2025_high` = 'High') %>%
cols_label(`2030_high` = 'High') %>%
cols_label(`2035_high` = 'High') %>%
cols_label(`2040_high` = 'High') %>%
cols_align('center', columns = everything()) %>%
cols_align('left', columns = stubhead) %>%
tab_spanner(label = "Historical ", columns = all_of(hist_years), level = 2) %>%
tab_spanner(label = "Projected", columns = all_of(proj_col_order))%>%
tab_header(title = paste0('Historical and Projected U.S. GHG Emissions (2023 Policy Baseline), by ',stubhead,': 2005-2040 (MMT CO2e)')) %>%
gt_theme_nc_blue()
gas_df <- create_summary_table('gas','wm', projections_all_sm, config)
sector_df <- create_summary_table('usproj_sector', 'wm', projections_all_sm, config)
View(gas_sf)
View(gas_df)
tar_source()
tar_load(c(projections_all_sm, config))
gas_df <- create_summary_table('gas','wm', projections_all_sm, config)
sector_df <- create_summary_table('usproj_sector', 'wm', projections_all_sm, config)
View(gas_df)
gas_table <- create_html_table(gas_df, 'Gas',config)
gas_table
gas_df$category <- html(gas_df$category)
row_label_md_gas <- function(row_id) {
case_when(
row_id == "CO2" ~ "CO<sub>2</sub>",
row_id == "CH4" ~ "CH<sub>4</sub>",
row_id == "N2O" ~ "N<sub>2</sub>O",
row_id == "SF6" ~ "SF<sub>6</sub>",
row_id == "NF3" ~ "NF<sub>3</sub>")
}
row_label_md_gas <- function(row_id) {
case_when(
row_id == "CO2" ~ "CO<sub>2</sub>",
row_id == "CH4" ~ "CH<sub>4</sub>",
row_id == "N2O" ~ "N<sub>2</sub>O",
row_id == "SF6" ~ "SF<sub>6</sub>",
row_id == "NF3" ~ "NF<sub>3</sub>")
}
create_html_table <- function(final_summary_table, stubhead, config){
hist_years <- c('2005','2010','2015','2020', config$base_year)
proj_col_order <- c('2025_low',
'2025_high',
'2030_low',
'2030_high',
'2035_low',
'2035_high',
'2040_low',
'2040_high')
html_table <-  final_summary_table %>%
rename(!!stubhead := category) %>%
gt() %>%
tab_spanner(label = "2025", columns = proj_col_order[1:2]) %>%
tab_spanner(label = "2030", columns = proj_col_order[3:4]) %>%
tab_spanner(label = "2035", columns = proj_col_order[5:6]) %>%
tab_spanner(label = "2040", columns = proj_col_order[7:8]) %>%
cols_label(`2025_low` = 'Low') %>%
cols_label(`2030_low` = 'Low') %>%
cols_label(`2035_low` = 'Low') %>%
cols_label(`2040_low` = 'Low') %>%
cols_label(`2025_high` = 'High') %>%
cols_label(`2030_high` = 'High') %>%
cols_label(`2035_high` = 'High') %>%
cols_label(`2040_high` = 'High') %>%
cols_align('center', columns = everything()) %>%
cols_align('left', columns = stubhead) %>%
tab_spanner(label = "Historical ", columns = all_of(hist_years), level = 2) %>%
tab_spanner(label = "Projected", columns = all_of(proj_col_order))%>%
tab_header(title = paste0('Historical and Projected U.S. GHG Emissions (2023 Policy Baseline), by ',stubhead,': 2005-2040 (MMT CO2e)')) %>%
text_transform(row_label_md_gas) %>%
gt_theme_nc_blue()
}
gas_table <- create_html_table(gas_df, 'Gas',config)
gas_table
View(gas_df)
gas_df <- create_summary_table('gas','wm', projections_all_sm, config)
sector_df <- create_summary_table('usproj_sector', 'wm', projections_all_sm, config)
View(gas_df)
create_summary_table <- function(category, grouping, projections_all_sm, config) {
col_order <- c('category','year','low','high')
summary <- projections_all_sm %>%
rename(category = .data[[category]]) %>%
filter(grouping == grouping) %>%
filter(year %in% config$table) %>%
group_by(proj_name,category, year) %>%
summarise(cat_sum = sum(sum),.groups='drop')
summary_total_gross <- summary %>%
filter(!category == 'LULUCF Sink') %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum),.groups='drop') %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year,low,high) %>%
distinct() %>%
mutate(category = 'Total Gross Emissions') %>%
select(all_of(col_order))
summary_total_net <- summary %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum),.groups='drop') %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year,low,high) %>%
distinct() %>%
mutate(category = 'Total Net Emissions') %>%
select(all_of(col_order))
if(category == 'gas'){
order_index <- c(2,1,4,3,6,7,5) # added NF3
processed_datasets <- list()
for(gas in config$gas_order){
cat_summary <- summary %>%
filter(category == gas) %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum),.groups='drop') %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year, low, high) %>%
distinct() %>%
mutate(category = gas) %>%
select(all_of(col_order))
processed_datasets[[gas]] <- cat_summary
}
summary_table_df <- bind_rows(processed_datasets)
#summary_table_df$category <- subscript_numbers(summary_table_df$category)
} else if(category == 'usproj_sector'){
processed_datasets <- list()
order_index <- c(2,4,3,1,5)
for(sector in config$sector_order){
cat_summary <- summary %>%
filter(category == sector) %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum),.groups='drop') %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year, low, high) %>%
distinct() %>%
mutate(category = sector) %>%
select(all_of(col_order))
processed_datasets[[sector]] <- cat_summary
}
summary_table_df <- bind_rows(processed_datasets)
summary_table_df$category <- ifelse(summary_table_df$category == 'IPPU', 'Industrial Processes', summary_table_df$category) # Change 'IPPU' to 'Industrial Processes'
}
else{rlang::abort('Enter "gas" or "usproj_sector" into as category.')}
summary_table_df_high_low <- create_high_low_df(summary_table_df, config)
summary_table_df_high_low <- summary_table_df_high_low[order_index,]
total_gross_emissions_high_low <- create_high_low_df(summary_total_gross, config)
total_net_emissions_high_low <- create_high_low_df(summary_total_net, config)
summary_lulucf_sink <- summary %>% filter(category == 'LULUCF Sink')%>%
group_by(category,proj_name, year) %>%
summarise(value = sum(cat_sum),.groups='drop') %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(category, year, low, high) %>%
distinct()
lulucf_sink_high_low <- create_high_low_df(summary_lulucf_sink, config)
final_summary_table <- summary_table_df_high_low %>%
rbind(total_gross_emissions_high_low) %>%
rbind(lulucf_sink_high_low) %>%
rbind(total_net_emissions_high_low)
rownames(final_summary_table) <- NULL
final_summary_table <- final_summary_table %>% mutate_if(is.numeric, round)
numeric_cols <- sapply(final_summary_table,is.numeric)
final_summary_table[, numeric_cols] <- lapply(final_summary_table[, numeric_cols], scales::comma)
return(final_summary_table)
}
gas_df <- create_summary_table('gas','wm', projections_all_sm, config)
View(gas_df)
gas_table <- create_html_table(gas_df, 'Gas',config)
gas_table
create_html_table <- function(final_summary_table, stubhead, config){
hist_years <- c('2005','2010','2015','2020', config$base_year)
proj_col_order <- c('2025_low',
'2025_high',
'2030_low',
'2030_high',
'2035_low',
'2035_high',
'2040_low',
'2040_high')
html_table <-  final_summary_table %>%
rename(!!stubhead := category) %>%
gt() %>%
tab_spanner(label = "2025", columns = proj_col_order[1:2]) %>%
tab_spanner(label = "2030", columns = proj_col_order[3:4]) %>%
tab_spanner(label = "2035", columns = proj_col_order[5:6]) %>%
tab_spanner(label = "2040", columns = proj_col_order[7:8]) %>%
cols_label(`2025_low` = 'Low') %>%
cols_label(`2030_low` = 'Low') %>%
cols_label(`2035_low` = 'Low') %>%
cols_label(`2040_low` = 'Low') %>%
cols_label(`2025_high` = 'High') %>%
cols_label(`2030_high` = 'High') %>%
cols_label(`2035_high` = 'High') %>%
cols_label(`2040_high` = 'High') %>%
cols_align('center', columns = everything()) %>%
cols_align('left', columns = stubhead) %>%
tab_spanner(label = "Historical ", columns = all_of(hist_years), level = 2) %>%
tab_spanner(label = "Projected", columns = all_of(proj_col_order))%>%
tab_header(title = paste0('Historical and Projected U.S. GHG Emissions (2023 Policy Baseline), by ',stubhead,': 2005-2040 (MMT CO2e)')) %>%
text_transform(location = cells_stub(), row_label_md_gas) %>%
gt_theme_nc_blue()
}
gas_table <- create_html_table(gas_df, 'Gas',config)
gas_table
gas_table <- create_html_table(gas_df, 'Gas',config)
gas_table
create_html_table <- function(final_summary_table, stubhead, config){
hist_years <- c('2005','2010','2015','2020', config$base_year)
proj_col_order <- c('2025_low',
'2025_high',
'2030_low',
'2030_high',
'2035_low',
'2035_high',
'2040_low',
'2040_high')
html_table <-  final_summary_table %>%
rename(!!stubhead := category) %>%
gt() %>%
text_transform(location = cells_stub(), row_label_md_gas) %>%
tab_spanner(label = "2025", columns = proj_col_order[1:2]) %>%
tab_spanner(label = "2030", columns = proj_col_order[3:4]) %>%
tab_spanner(label = "2035", columns = proj_col_order[5:6]) %>%
tab_spanner(label = "2040", columns = proj_col_order[7:8]) %>%
cols_label(`2025_low` = 'Low') %>%
cols_label(`2030_low` = 'Low') %>%
cols_label(`2035_low` = 'Low') %>%
cols_label(`2040_low` = 'Low') %>%
cols_label(`2025_high` = 'High') %>%
cols_label(`2030_high` = 'High') %>%
cols_label(`2035_high` = 'High') %>%
cols_label(`2040_high` = 'High') %>%
cols_align('center', columns = everything()) %>%
cols_align('left', columns = stubhead) %>%
tab_spanner(label = "Historical ", columns = all_of(hist_years), level = 2) %>%
tab_spanner(label = "Projected", columns = all_of(proj_col_order))%>%
tab_header(title = paste0('Historical and Projected U.S. GHG Emissions (2023 Policy Baseline), by ',stubhead,': 2005-2040 (MMT CO2e)')) %>%
gt_theme_nc_blue()
}
create_html_table <- function(final_summary_table, stubhead, config){
hist_years <- c('2005','2010','2015','2020', config$base_year)
proj_col_order <- c('2025_low',
'2025_high',
'2030_low',
'2030_high',
'2035_low',
'2035_high',
'2040_low',
'2040_high')
html_table <-  final_summary_table %>%
rename(!!stubhead := category) %>%
gt() %>%
text_transform(location = cells_stub(), row_label_md_gas) %>%
tab_spanner(label = "2025", columns = proj_col_order[1:2]) %>%
tab_spanner(label = "2030", columns = proj_col_order[3:4]) %>%
tab_spanner(label = "2035", columns = proj_col_order[5:6]) %>%
tab_spanner(label = "2040", columns = proj_col_order[7:8]) %>%
cols_label(`2025_low` = 'Low') %>%
cols_label(`2030_low` = 'Low') %>%
cols_label(`2035_low` = 'Low') %>%
cols_label(`2040_low` = 'Low') %>%
cols_label(`2025_high` = 'High') %>%
cols_label(`2030_high` = 'High') %>%
cols_label(`2035_high` = 'High') %>%
cols_label(`2040_high` = 'High') %>%
cols_align('center', columns = everything()) %>%
cols_align('left', columns = stubhead) %>%
tab_spanner(label = "Historical ", columns = all_of(hist_years), level = 2) %>%
tab_spanner(label = "Projected", columns = all_of(proj_col_order))%>%
tab_header(title = paste0('Historical and Projected U.S. GHG Emissions (2023 Policy Baseline), by ',stubhead,': 2005-2040 (MMT CO2e)')) %>%
gt_theme_nc_blue()
}
gas_table <- create_html_table(gas_df, 'Gas',config)
gas_table
?text_transform
View(gas_df)
html_table <-  final_summary_table %>%
rename(!!stubhead := category)
final_summary_table <- gas_df
View(final_summary_table)
html_table <-  final_summary_table %>%
rename(!!stubhead := category)
stubhead = 'Gas'
html_table <-  final_summary_table %>%
rename(!!stubhead := category)
View(html_table)
html_table <-  final_summary_table %>%
text_transform(row_label_md_gas(final_summary_table$category))
final_summary_table$category
html_table <-  final_summary_table  %>%
rename(!!stubhead := category) %>%
gt() %>%
text_transform(row_label_md_gas(final_summary_table$category))
html_table
html_table
html_table <-  final_summary_table  %>%
rename(!!stubhead := category) %>%
gt() %>%
text_transform(row_label_md_gas(final_summary_table$category))
html_table
html_table
html_table <-  final_summary_table  %>%
rename(!!stubhead := category)
html_table <-  final_summary_table
View(html_table)
html_table <-  final_summary_table  %>%
mutate(category = row_label_md_gas(final_summary_table$category))
row_label_md_gas <- function(row_id) {
case_when(
row_id == "CO2" ~ "CO<sub>2</sub>",
row_id == "CH4" ~ "CH<sub>4</sub>",
row_id == "N2O" ~ "N<sub>2</sub>O",
row_id == "SF6" ~ "SF<sub>6</sub>",
row_id == "NF3" ~ "NF<sub>3</sub>")
}
row_label_md_gas <- function(row_id) {
case_when(
category == "CO2" ~ "CO<sub>2</sub>",
category == "CH4" ~ "CH<sub>4</sub>",
category == "N2O" ~ "N<sub>2</sub>O",
category == "SF6" ~ "SF<sub>6</sub>",
category == "NF3" ~ "NF<sub>3</sub>")
}
html_table <-  final_summary_table  %>%
mutate(category = row_label_md_gas(final_summary_table$category))
html_table <-  final_summary_table  %>%
mutate(category = row_label_md_gas(category))
glimpse(final_summary_table)
row_label_md_gas <- function(row_id) {
case_when(
Gas == "CO2" ~ "CO<sub>2</sub>",
Gas == "CH4" ~ "CH<sub>4</sub>",
Gas == "N2O" ~ "N<sub>2</sub>O",
Gas == "SF6" ~ "SF<sub>6</sub>",
Gas == "NF3" ~ "NF<sub>3</sub>")
}
html_table <-  final_summary_table  %>%
rename(!!stubhead := category)
View(html_table)
html_table <-  final_summary_table  %>%
rename(!!stubhead := category) %>%
gt() %>%
text_transform(row_label_md_gas)
html_table
html_table <-  final_summary_table  %>%
rename(!!stubhead := category) %>%
gt()
html_table
html_table$`_row_groups`
html_table$`_spanners`
subscript_numbers <- function(string) {
gsub("([0-9]+)","<sub>\\1</sub>",string,perl = TRUE)
}
html_table <-  final_summary_table  %>%
rename(!!stubhead := category) %>%
gt() %>%
text_transform(locations = cells_body(columns = 1),
fn = function(x) {
subscript_numbers(x)
})
html_table
tar_load(c(projections_all_sm, config))
tar_source()
gas_df <- create_summary_table('gas','wm', projections_all_sm, config)
sector_df <- create_summary_table('usproj_sector', 'wm', projections_all_sm, config)
gas_table <- create_html_table(gas_df, 'Gas',config)
gas_table
sector_table <- create_html_table(sector_df, 'Sector',config)
sector_table
# Create html table in the style of gt()
create_pct_change_html_table <- function(final_summary_table, stubhead, config){
hist_years <- c('2005','2010','2015','2020', config$base_year)
proj_col_order <- c('2025_low',
'2025_high',
'2030_low',
'2030_high',
'2035_low',
'2035_high',
'2040_low',
'2040_high')
html_table <-  final_summary_table %>%
rename(!!stubhead := category) %>%
gt() %>%
text_transform(locations = cells_body(columns = 1),
fn = function(x) {
subscript_numbers(x)
}) %>%
tab_spanner(label = "2025", columns = proj_col_order[1:2]) %>%
tab_spanner(label = "2030", columns = proj_col_order[3:4]) %>%
tab_spanner(label = "2035", columns = proj_col_order[5:6]) %>%
tab_spanner(label = "2040", columns = proj_col_order[7:8]) %>%
cols_label(`2025_low` = 'Low') %>%
cols_label(`2030_low` = 'Low') %>%
cols_label(`2035_low` = 'Low') %>%
cols_label(`2040_low` = 'Low') %>%
cols_label(`2025_high` = 'High') %>%
cols_label(`2030_high` = 'High') %>%
cols_label(`2035_high` = 'High') %>%
cols_label(`2040_high` = 'High') %>%
cols_align('center', columns = everything()) %>%
cols_align('left', columns = stubhead) %>%
#tab_spanner(label = "Historical ", columns = all_of(hist_years), level = 2) %>%
tab_spanner(label = "Projected", columns = all_of(proj_col_order))%>%
tab_header(title = paste0('Projected Percent Change U.S. GHG Emissions Compared to 2005 Levels (2023 Policy Baseline), by ',stubhead,': 2025-2040 (%)')) %>%
gt_theme_nc_blue()
}
pct_change_table_gas <- create_pct_change_table('gas', 'wm', projections_all_sm, config)
pct_change_html_gas <- create_pct_change_html_table(pct_change_table_gas, 'Gas', config)
pct_change_html_gas
tar_make(results_overview)
tar_invalidate(results_overview)
tar_make(results_overview)
tar_make(results_overview)
# Load packages required to define the pipeline:
library(targets)
library(tarchetypes)
source("packages.R")
