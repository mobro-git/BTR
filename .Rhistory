if (year > config$base_year) {
if (model == 'usproj') {
proj_names[i] <- 'usproj'
}
else if (model %in% crosswalk_compilation$ffc_model & scenario %in% crosswalk_compilation$ffc_scen) {
merged_row <- row %>% left_join(crosswalk_compilation, by = c('model'='ffc_model', 'scenario'='ffc_scen'))
proj_names[i] <- merged_row$proj_name
}
else print(paste('Model/Scenario combo:', '(',model,', ',scenario,')', ', is not recognized.'))
}
else proj_names[i] <- 'ghgi_historical'
}
i=3
row <- proj_usa[i,]
model <- row$model
scenario <- row$scenario
year <- row$year
model %in% crosswalk_compilation$ffc_model & scenario %in% crosswalk_compilation$ffc_scen
year > config$base_year
proj_names[i] <- 'ghgi_historical'
rm(proj_names)
proj_names <- vector('character', nrow(proj_usa))
proj_names[i] <- 'ghgi_historical'
i = 1
row <- proj_usa[i,]
model <- row$model
scenario <- row$scenario
year <- row$year
if (year > config$base_year) {
if (model == 'usproj') {
proj_names[i] <- 'usproj'
}
else if (model %in% crosswalk_compilation$ffc_model & scenario %in% crosswalk_compilation$ffc_scen) {
merged_row <- row %>% left_join(crosswalk_compilation, by = c('model'='ffc_model', 'scenario'='ffc_scen'))
proj_names[i] <- merged_row$proj_name
}
else print(paste('Model/Scenario combo:', '(',model,', ',scenario,')', ', is not recognized.'))
}
year > config$base_year
proj_names[i] <- 'ghgi_historical'
View(proj_usa)
View(crosswalk_compilation)
View(proj_usa)
View(test_30)
tar_make()
tar_make()
tar_make()
tar_load(c(lulucf_files, lulucf_crosswalk_csv))
tar_load(lulucf_crosswalk)
filepath <- lulucf_files[1]
print(paste0("Reading ",filepath))
read_raw_data_file(filepath) %>%
map_lulucf(lulucf_crosswalk)}
lulucf_test <- read_raw_data_file(filepath)
tar_source()
lulucf_test <- read_raw_data_file(filepath)
View(lulucf_test)
data <- lulucf_test
join_vars <- c("datasrc", "model", "scenario")
# make sure crosswalk has everything needed
preflight <- distinct_at(data, join_vars) %>%
anti_join(lulucf_crosswalk, by = join_vars)
scen_mapping <- select(lulucf_crosswalk, join_vars, model_new, scenario_new)
rm(scen_mapping)
scen_mapping <- select(lulucf_crosswalk, all_of(join_vars), model_new, scenario_new)
View(scen_mapping)
res <- data %>%
left_join(scen_mapping, by = join_vars) %>%
mutate(
model = model_new,
scenario = scenario_new
) %>%
select(-model_new, -scenario_new) %>%
select(model, scenario, region, year, variable, unit, value, everything()) %>%
assert_has_standard_cols()
View(res)
tar_make()
tar_make()
tar_load(lulucf_data)
View(lulucf_data)
rm(proj_usa)
tar_load(proj_usa)
View(proj_usa)
tar_load(var_crosswalk)
View(var_crosswalk)
tar_make()
View(lulucf_data)
tar_make(lulucf_data)
tar_make(lulucf_data)
tar_load(lulucf_data)
View(lulucf_data)
usproj_no_ffc_proj = usproj_data_long %>%
# remove FFC projections, keep only historic data - *****EXCEPT KEEP FFCUST PROJECTIONS (not in crosswalk)*****
filter(!(
usproj_category %in% unique(var_crosswalk$usproj_category) &
year > config$base_year)) %>%
mutate(btr_var = "") %>%
rbind(ffc_raw_data)
tar_load(usproj_data_long)
tar_load(ffc_raw_dasta)
tar_load(ffc_raw_data)
usproj_no_ffc_proj = usproj_data_long %>%
# remove FFC projections, keep only historic data - *****EXCEPT KEEP FFCUST PROJECTIONS (not in crosswalk)*****
filter(!(
usproj_category %in% unique(var_crosswalk$usproj_category) &
year > config$base_year)) %>%
mutate(btr_var = "") %>%
rbind(ffc_raw_data)
lulucf_ordered = lulucf_data %>% select(names(usproj_no_ffc_proj)) %>% rbind(usproj_no_ffc_proj)
View(lulucf_ordered)
# Load packages required to define the pipeline:
library(targets)
library(tarchetypes)
source("packages.R")
# Load packages required to define the pipeline:
library(targets)
library(tarchetypes)
source("packages.R")
tar_make()
tar_load(projection_all)
tar_load(projections_all)
View(projections_all)
View(projections_all)
tar_load(usproj_all)
View(usproj_all)
tar_load(config)
View(config)
historical <- usproj_all %>% filter(year <= config$base_year)
View(historical)
historical <- usproj_all %>% filter(region = 'United States') %>% filter(year <= config$base_year)
historical <- usproj_all %>% filter(region == 'United States') %>% filter(year <= config$base_year)
View(historical)
historical_ghgi <- historical %>% mutate(model == 'ghgi')
View(historical_ghgi)
historical_ghgi <- historical %>% mutate(model = 'ghgi')
historical_ghgi <- historical %>% mutate(proj_name = 'ghgi') %>% mutate(model = 'ghgi') %>% mutate(scenario = 'ghgi') %>% select(names(projections_all))
View(historical_ghgi)
historical_ghgi <- historical %>% mutate(proj_name = 'ghgi') %>%
mutate(model = 'ghgi') %>%
mutate(scenario = 'historical') %>%
select(names(projections_all))
projections_all <- projections_all %>% rbind(historical_ghgi)
View(projections_all)
config$fives
config$fives_lts
View(projections_all)
unique(projections_all$unit)
View(projections_all %>% filter(unit=="MMT CO2e"))
View(projections_all %>% filter(unit=="MMTCO2e"))
View(projections_all %>% filter(unit=="Mt CO2/yr"))
proj_group <- projections_all %>% group_by(proj_name, gas, usproj_sector, unit, year) %>% summarise(sum = sum())
View(proj_group)
proj_group <- projections_all %>% group_by(proj_name, gas, usproj_sector, unit, year) %>% summarise(sum = sum(value))
View(proj_group)
tar_source()
View(proj_group)
tar_make(config)
config$fives
fives = c(seq(2005,2022,by = 5),seq(2025,2040,by = 5))
fives
fives = c(seq(2005,2020,by = 5),2022,seq(2025,2040,by = 5)
fives = c(seq(2005,2020,by = 5),2022,seq(2025,2040,by = 5))
fives = c(seq(2005,2020,by = 5),2022,seq(2025,2040,by = 5))
fives
fives_sum <- proj_group %>% filter(year %in% fives)
View(fives_sum)
gas_dataset <- fives_sum %>% group_by(gas) %>% summarise(sum = sum(value))
gas_dataset <- fives_sum %>% group_by(gas) %>% summarise(value = sum(sum))
View(gas_dataset)
gas_dataset <- fives_sum %>% group_by(gas, year) %>% summarise(value = sum(sum))
gas_dataset <- fives_sum %>% group_by(gas, year) %>% summarise(mmtco2e = sum(sum))
sector_dataset <- fives_sum %>% group_by(usproj_sector, year) %>% summarise(mmtco2e = sum(sum))
View(sector_dataset)
# Load packages required to define the pipeline:
library(targets)
library(tarchetypes)
source("packages.R")
tar_load(c(projections_all,config,usproj_all))
historical <- usproj_all %>% filter(region == 'United States') %>% filter(year <= config$base_year)
historical_ghgi <- historical %>% mutate(proj_name = 'ghgi') %>%
mutate(model = 'ghgi') %>%
mutate(scenario = 'historical') %>%
select(names(projections_all))
projections_all <- projections_all %>% rbind(historical_ghgi)
proj_group <- projections_all %>% group_by(proj_name, gas, usproj_sector, unit, year) %>% summarise(sum = sum(value))
fives_sum <- proj_group %>% filter(year %in% config$fives)
gas_dataset <- fives_sum %>% group_by(gas, year) %>% summarise(mmtco2e = sum(sum))
sector_dataset <- fives_sum %>% group_by(usproj_sector, year) %>% summarise(mmtco2e = sum(sum))
projections_all_sm <- projections_all %>% group_by(proj_name, gas, usproj_sector, unit, year) %>% summarise(sum = sum(value))
View(projections_all_sm)
tar_source()
tar_make()
tar_make()
tar_make()
targets::tar_meta(fields = error, complete_only = TRUE)
tar_make()
tar_make()
tar_load(projections_all_sm)
View(projections_all_sm)
tar_make()
tar_load(config)
fives_sum <- projections_all_sm %>% filter(year %in% config$fives)
group = 'usproj_sector'
dataset <- fives_sum %>% group_by(group, year) %>% summarise(mmtco2e = sum(sum))
dataset <- fives_sum %>% group_by(group, year) %>% summarise(mmtco2e = sum(sum))
tar_make()
tar_make(gas_dataset)
group='gas'
group_name <- group
fives_sum <- projections_all_sm %>% filter(year %in% config$fives)
dataset <- fives_sum %>% group_by(group_name, year) %>% summarise(mmtco2e = sum(sum))
?group_by
tar_make()
tar_load(gas_dataset)
View(gas_dataset)
years <- c(2005,2010,2015,config$base_year,2025,2030,2035,2040)
View(gas_dataset)
gas_dataset_years <- gas_dataset %>% filter(year %in% years)
View(projections_all_sm)
unique(projections_all_sm$gas)
proj_sm_30 <- projections_all_sm %>% filter(year=='2030')
View(proj_sm_30)
View(gas_dataset_years)
gas_30 <- gas_dataset %>% filter(year=='2030')
View(gas_30)
?arrange
fives_sum <- projections_all_sm %>% filter(year %in% config$fives)
dataset <- fives_sum %>% group_by(usproj_sector, year) %>% summarise(mmtco2e = sum(sum))
View(dataset)
dataset <- fives_sum %>% group_by(usproj_sector, year) %>% summarise(mmtco2e = sum(sum)) %>% filter(!gas=='LULUCF Sink')
View(dataset)
dataset <- fives_sum %>% group_by(gas, year) %>% summarise(mmtco2e = sum(sum)) %>% filter(!gas=='LULUCF Sink')
View(dataset)
View(fives_sum)
tar_load(projections_all)
View(projections_all)
tar_load(add_hist_data)
View(add_hist_data)
hist30 <- add_hist_data %>% filter(year=='2030')
View(hist30)
hist30 <- add_hist_data %>% filter(year=='2030') %>% filter(usproj_sector=='Energy')%>% filter(gas=='CO2')
View(projections_all)
projections_all_sm <- add_hist_data %>% group_by(proj_name, gas, usproj_sector, unit, year) %>% summarise(sum = sum(value))
View(projections_all_sm)
fives_sum <- projections_all_sm %>% filter(year %in% config$fives)
fives_sum <- projections_all_sm %>% filter(year %in% config$table)
View(fives_sum)
rm(projections_all_sm)
tar_make(projections_all_sm)
tar_make(projections_all_sm)
tar_load(projections_all_sm)
View(projections_all_sm)
tar_make()
tar_load(projections_all_sm)
tar_load(config)
years_sum <- projections_all_sm %>% filter(year %in% config$table)
View(years_sum)
View(years_sum %>% filter(year=='2030'))
tar_load(projections_all)
proj_name = 'test2'
projections_all_sm <- projections_all %>% group_by(proj_name, gas, usproj_sector, unit, year) %>% summarise(sum = sum(value)) %>% filter(proj_name %in% c('ghgi', proj_name))
View(projections_all_sm)
projections_all_sm <- projections_all %>%
group_by(proj_name, gas, usproj_sector, unit, year) %>%
summarise(sum = sum(value)) %>%
filter(proj_name %in% c('ghgi', proj_name))
rm(projections_all_sm)
projections_all_sm <- projections_all %>%
group_by(proj_name, gas, usproj_sector, unit, year) %>%
summarise(sum = sum(value))
projections_all_sm <- projections_all %>%
group_by(proj_name, gas, usproj_sector, unit, year) %>%
summarise(sum = sum(value)) %>%
filter(proj_name %in% c('ghgi', proj_name))
projections_all %>%
filter(proj_name %in% c('ghgi', proj_name))
projections_all_sm <- projections_all %>%
filter(proj_name %in% c('ghgi', proj_name))
View(projections_all_sm)
scen=''
projections_all_sm <- projections_all %>%
filter(proj_name %in% c('ghgi', scen))
scen='test2'
projections_all_sm <- projections_all %>%
filter(proj_name %in% c('ghgi', scen))
View(projections_all_sm)
View(projections_all)
unique(projections_all$proj_name)
tar_load(add_hist_data)
View(add_hist_data)
projections_all_sm <- add_hist_data %>%
filter(proj_name %in% c('ghgi', scen))
View(projections_all)
View(projections_all_sm)
projections_all_sm <- add_hist_data %>%
filter(proj_name %in% c('ghgi', scen)) %>%
group_by(proj_name, gas, usproj_sector, unit, year) %>%
summarise(sum = sum(value))
View(projections_all_sm)
years_sum <- projections_all_sm %>% filter(year %in% config$table)
dataset <- years_sum %>% group_by(gas, year) %>% summarise(mmtco2e = sum(sum)) %>% filter(!gas=='LULUCF Sink')
View(dataset)
dataset <- years_sum %>% group_by(gas, year) %>% summarise(mmtco2e = sum(sum))
View(years_sum)
tar_make()
tar_make()
years_sum <- projections_all_sm %>% filter(year %in% config$table)
dataset <- years_sum %>% group_by(gas, year) %>% summarise(mmtco2e = sum(sum)) %>% filter(!gas=='LULUCF Sink')
tar_make()
tar_load(gas_dataset)
View(gas_dataset)
View(projections_all_sm)
lulucf_sink_df <- projections_all_sm %>% filter(gas=='LULUCF Sink')
View(lulucf_sink_df)
lulucf_sink_df <- projections_all_sm %>%
filter(gas=='LULUCF Sink') %>%
filter(year %in% config$table)
View(lulucf_sink_df)
dataset_wide <- dataset %>% pivot_wider()
dataset_wide <- dataset %>% pivot_wider(names_from = year)
View(dataset)
dataset_wide <- dataset %>% pivot_wider(names_from = year,
values_from = mmtco2e)
View(dataset_wide)
View(dataset_wide)
tar_make(config)
config = list(
version = "2024_BTR1",
scen_mapping = read_scen_mapping(crosswalk_model_runs_csv),
template = template,
calculated_var = all_calculated,
base_year = 2021, # TODO: update to 2022 when we get updated inventory
#models
models = c("GCAM-LTS","GCAM-PNNL","NEMS-OP","USREP-ReEDS"),
fives = c(seq(2005,2020,by = 5),2022,seq(2025,2040,by = 5)),
annual = c(seq(2005,2040,by = 1)),
fives_lts = c(seq(2005,2022,by = 1),seq(2025,2050,by = 5)),
annual_lts = c(seq(2005,2050,by = 1)),
annual_1990 = c(seq(1990,2040,by = 1)),
annual_2010 = c(seq(2010,2040,by = 1)),
table = c(2005, 2010, 2015, 2020, 2022, 2025, 2030 , 2035, 2040),
gas_order <-
c("CO2", "CH4", "N2O", "HFCs", "PFCs", "SF6", "NF3"),
sector_order <-
c("Energy",
"Transportation",
"Industrial Processes",
"Agriculture",
'Waste')
)
tar_make()
tar_make()
tar_make()
tar_make()
tar_make()
tar_make()
tar_load(config)
tar_make(config)
rm(config)
tar_load(config)
config$gas_order
tar_make(config)
rm(config)
tar_load(config)
config$gas_order
dataset <- years_sum %>%
group_by(gas, year) %>%
summarise(mmtco2e = sum(sum)) %>%
filter(!gas=='LULUCF Sink')
View(dataset)
dataset_wide <- dataset %>% pivot_wider(names_from = year,
values_from = mmtco2e)
View(dataset_wide)
dataset_wide <- dataset %>% pivot_wider(names_from = year,
values_from = mmtco2e) %>%
arrange(factor(gas, levels = config$gas_order))
years_sum <- projections_all_sm %>% filter(year %in% config$table)
dataset <- years_sum %>% group_by(usproj_sector, year) %>% summarise(mmtco2e = sum(sum)) %>% filter(!usproj_sector=='LULUCF Sink')
dataset_wide <- dataset %>% pivot_wider(names_from = year,
values_from = mmtco2e)%>%
arrange(factor(usproj_sector, levels = config$sector_order))
lulucf_sink_df <- projections_all_sm %>%
filter(gas=='LULUCF Sink') %>%
filter(year %in% config$table)
View(lulucf_sink_df)
View(lulucf_sink_df)
lulucf_sink_wide <- lulucf_sink_df %>% pivot_wider(names_from = year,
values_from = sum)
View(lulucf_sink_wide)
lulucf_sink_df <- projections_all_sm %>%
filter(gas=='LULUCF Sink') %>%
filter(year %in% config$table) %>%
select(gas,year,sum)
lulucf_sink_wide <- lulucf_sink_df %>% pivot_wider(names_from = year,
values_from = sum)
View(lulucf_sink_df)
projections_all_sm %>%
select(gas,year,sum)
filter(gas=='LULUCF Sink') %>%
filter(year %in% config$table)
View(projections_all_sm)
lulucf_sink_df <- projections_all_sm %>%
select(gas,year,sum)
filter(gas=='LULUCF Sink') %>%
filter(year %in% config$table)
View(projections_all_sm)
View(projections_all_sm)
lulucf_sink_df <- projections_all_sm %>%
select(gas,year,sum)
unique(projections_all_sm$gas)
lulucf_sink_df <- projections_all_sm %>%
select(gas,year,sum)
View(lulucf_sink_df)
projections_all_sm <- add_hist_data %>%
group_by(proj_name, gas, usproj_sector, unit, year) %>%
filter(proj_name %in% c('ghgi', scen)) %>%
summarise(sum = sum(value))
lulucf_sink_df <- projections_all_sm %>%
select(gas,year,sum)
View(lulucf_sink_wide)
lulucf_sink_df <- projections_all_sm %>%
select(gas,year,sum)
projections_all_sm %>% ungroup() %>%
select(gas,year,sum)
filter(gas=='LULUCF Sink') %>%
filter(year %in% config$table)
lulucf_sink_df <- projections_all_sm %>% ungroup() %>%
select(gas,year,sum)
filter(gas=='LULUCF Sink') %>%
filter(year %in% config$table)
lulucf_sink_df <- projections_all_sm %>% ungroup() %>%
select(gas,year,sum)
View(lulucf_sink_df)
lulucf_sink_df <- projections_all_sm %>% ungroup() %>%
select(gas,year,sum) %>%
filter(gas=='LULUCF Sink') %>%
filter(year %in% config$table)
View(lulucf_sink_df)
lulucf_sink_df <- projections_all_sm %>% ungroup() %>%
select(gas,year,sum) %>%
filter(gas=='LULUCF Sink') %>%
filter(year %in% config$table)
lulucf_sink_wide <- lulucf_sink_df %>% pivot_wider(names_from = year,
values_from = sum)
View(lulucf_sink_wide)
total_gross_emissions_df <- projections_all_sm %>% ungroup %>%
filter(!gas=='LULUCF Sink') %>%
select(gas, year, sum)
View(total_gross_emissions_df)
total_gross_emissions_df <- projections_all_sm %>% ungroup %>%
filter(!gas=='LULUCF Sink')
View(total_gross_emissions_df)
total_gross_emissions_df <- projections_all_sm %>% ungroup %>%
filter(!gas=='LULUCF Sink') %>%
filter(year %in% config$table)
View(total_gross_emissions_df)
total_gross_emissions_df <- projections_all_sm %>% ungroup %>%
filter(!gas=='LULUCF Sink') %>%
filter(year %in% config$table) %>%
group_by(year) %>%
summarise('Total Gross Emissions' = sum(sum))}
total_gross_emissions_df <- projections_all_sm %>% ungroup %>%
filter(!gas=='LULUCF Sink') %>%
filter(year %in% config$table) %>%
group_by(year) %>%
summarise('Total Gross Emissions' = sum(sum))
View(total_gross_emissions_df)
tge_wide <- total_gross_emissions_df %>% pivot_wider(names_from = year,
values_from = 'Total Gross Emissions')
View(tge_wide)
View(total_gross_emissions_df)
tne_gas <- data.frame(Gas = 'Total Net Emissions')
View(tne_gas)
tge_header <- tne_gas
tge_final <- cbind(tge_header,tge_wide)
View(tge_final)
View(lulucf_sink_wide)
View(tge_final)
View(lulucf_sink_wide)
lulucf_sink_df <- projections_all_sm %>% ungroup() %>%
select(gas,year,sum) %>%
filter(gas=='LULUCF Sink') %>%
filter(year %in% config$table)
lulucf_sink_wide <- lulucf_sink_df %>% pivot_wider(names_from = year,
values_from = sum)
View(lulucf_sink_wide)
years_sum <- projections_all_sm %>% filter(year %in% config$table)
dataset <- years_sum %>% group_by(usproj_sector, year) %>% summarise(mmtco2e = sum(sum)) %>% filter(!usproj_sector=='LULUCF Sink')
dataset_wide <- dataset %>% pivot_wider(names_from = year,
values_from = mmtco2e)%>%
arrange(factor(usproj_sector, levels = config$sector_order))
View(dataset_wide)
tar_make()
View(tge_final)
tar_load(lulucf_sink_df)
tar_load(lulucf_sink_df)
rm(lulucf_sink_df)
tar_load(lulucf_sink_df)
tar_make()
tar_make()
tar_load(lulucf_sink_df)
View(lulucf_sink_df)
tne <- tge_final - lulucf_sink_df
tar_source()
# Load packages required to define the pipeline:
library(targets)
library(tarchetypes)
source("packages.R")
tar_make()
# Load packages required to define the pipeline:
library(targets)
library(tarchetypes)
