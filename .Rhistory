tar_make()
tar_make()
tar_make()
tar_load(gas_breakout)
tar_load(lulucf_sink_breakout)
cols_gas_breakout <- colnames(gas_breakout)
missing_cols <- setdiff(cols_gas_breakout, colnames(lulucf_sink_breakout))
lulucf_sink_breakout[missing_cols] <- NA
lulucf_sink_breakout <- lulucf_sink_breakout[, cols_gas_breakout]
combined_df <- bind_rows(gas_breakout, lulucf_sink_breakout)
tne_df <- summarise_emissions(combined_df)%>%
mutate(source = 'Total Net Emissions') %>%
select(proj_name,source, everything())
tne_df <- gen_total_gross_emissions(combined_df)%>%
mutate(source = 'Total Net Emissions') %>%
select(proj_name,source, everything())
gen_total_gross_emissions <- function(gas_breakout_df){
summarized_df <- gas_breakout_df %>% group_by(proj_name) %>%
summarise(across(where(is.numeric), sum, na.rm=TRUE)) %>%
mutate(source = 'Total Gross Emissions') %>%
select(proj_name,source, everything())
}
tne_df <- gen_total_gross_emissions(combined_df)%>%
mutate(source = 'Total Net Emissions') %>%
select(proj_name,source, everything())
tar_make()
View(tne_df)
View(tne_df)
tar_load(gas_breakout)
View(gas_breakout)
tar_load(total_gross_emissions)
tar_load(total_net_emissions)
View(total_net_emissions)
View(total_gross_emissions)
tne_long <- total_net_emissions %>% pivot_longer(cols = as.character(config$table),
names_to = 'year',
values_to = 'value') %>% select(proj_name,year,value)
tar_load(config)
View(total_net_emissions)
tne_long <- total_net_emissions %>% pivot_longer(cols = as.character(config$table),
names_to = 'year',
values_to = 'value') %>% select(proj_name,year,value)
View(tne_long)
View(total_net_emissions)
tne <- total_net_emissions %>% select(!source)
View(tne)
tne_long <- tne %>% pivot_longer(cols = as.character(config$table),
names_to = 'year',
values_to = 'value')
View(tne_long)
View(gas_breakout)
tar_visnetwork(targets_only = TRUE)
tar_load(gas_dataset)
View(gas_dataset)
tar_load(proj_all_sm)
tar_load(projections_all_sm)
View(projections_all_sm)
View(projections_all_sm %>% filter(year == 20202))
View(projections_all_sm %>% filter(year == 2020))
tar_load(usproj_all)
View(usproj_all)
View(usproj_all %>% filter(year==2020))
View(usproj_all %>% filter(year==2025))
tar_load(add_hist_data)
View(add_hist_data)
View(usproj_all)
tar_load(projections_all)
View(projections_all)
historical <- usproj_all %>% filter(region == 'United States') %>% filter(year <= config$base_year)
historical_ghgi <- historical %>% mutate(proj_name = 'ghgi') %>%
mutate(model = 'ghgi') %>%
mutate(scenario = 'historical') %>%
select(names(projections_all))
projections_all <- projections_all %>% rbind(historical_ghgi)
add_hist_data <- projections_all
View(add_hist_data)
hist_2020 <- add_hist_data %>% filter(year==2020)
View(hist_2020)
View(usproj_all)
View(projections_all_sm)
View(projections_all_sm)
View(projections_all_sm %>% filter(gas =='CO2')%>% filter(year ==2020)%>% filter(usproj_sector =='Energy'))
View(historical%>% filter(gas =='CO2')%>% filter(year ==2020)%>% filter(usproj_sector =='Energy'))
projections_all_sm <- add_hist_data %>%
group_by(proj_name, gas, usproj_sector, year) %>%
summarise(sum = sum(value))
View(projections_all_sm)
projections_all_sm <- add_hist_data %>%
group_by(proj_name, gas, usproj_sector,unit, year) %>%
summarise(sum = sum(value))
View(gas_dataset)
years_sum <- projections_all_sm %>% filter(year %in% config$table)
View(years_sum)
View(projections_all_sm)
projections_all_sm <- add_hist_data %>%
group_by(proj_name, gas, usproj_sector,unit, year) %>%
summarise(sum = sum(value))
View(projections_all_sm)
View(historical)
View(historical_ghgi)
View(add_hist_data)
View(hist_2020)
hist_2020_dist <- hist_2020 %>% distinct()
View(hist_2020_dist)
projections_all_sm <- add_hist_data %>%
group_by(proj_name, gas, usproj_sector,unit, year) %>%
summarise(sum = sum(value)) %>% distinct()
projections_all_sm <- add_hist_data%>% distinct() %>%
group_by(proj_name, gas, usproj_sector,unit, year) %>%
summarise(sum = sum(value))
projections_all_sm <- add_hist_data%>% distinct() %>%
group_by(proj_name, gas, usproj_sector,unit, year) %>%
summarise(sum = sum(value))
years_sum <- projections_all_sm %>% filter(year %in% config$table)
gas_dataset <- years_sum %>%
group_by(proj_name, gas, year) %>%
summarise(mmtco2e = sum(sum))
View(gas_dataset)
usproj_all <- usproj_all %>% distinct()
View(usproj_all)
historical <- usproj_all %>% filter(region == 'United States') %>% filter(year <= config$base_year)
historical_ghgi <- historical %>% mutate(proj_name = 'ghgi') %>%
mutate(model = 'ghgi') %>%
mutate(scenario = 'historical')
View(historical_ghgi)
tar_load(crosswalk_compilation)
View(crosswalk_compilation)
View(usproj_all)
usproj_2020 <- usproj_all %>% filter(year==2020)
View(usproj_2020)
View(usproj_2020 %>% group_by(model,scenario,usproj_sector,gas,unit,usproj_source)) %>% summarise(sum = sum(value))
usproj_2020_sum <- usproj_2020 %>% group_by(model,scenario,usproj_sector,gas,unit,usproj_source)) %>% summarise(sum = sum(value)
usproj_2020_sum <- usproj_2020 %>% group_by(model,scenario,usproj_sector,gas,unit,usproj_source) %>% summarise(sum = sum(value)
usproj_2020_sum <- usproj_2020 %>% group_by(model,scenario,usproj_sector,gas,unit,usproj_source) %>% summarise(sum = sum(value))
View(usproj_2020_sum)
# Load packages required to define the pipeline:
library(targets)
library(tarchetypes)
source("packages.R")
tar_invalidate(everything())
tar_make(projections_all_sm)
years_sum <- projections_all_sm %>% filter(year %in% config$table)
years_sum <- projections_all_sm %>% filter(year %in% config$table)
gas_dataset <- years_sum %>%
group_by(proj_name, gas, year) %>%
summarise(mmtco2e = sum(sum))
View(gas_dataset)
tar_make()
category_order <- config$gas_order
lulucf_sink_df <- projections_all_sm %>% ungroup() %>%
select(proj_name,gas,year,sum) %>%
filter(gas=='LULUCF Sink') %>%
filter(year %in% config$table)
years_lulucf_sink <- as.character(unique(lulucf_sink_df$year))
lulucf_sink_hist <- lulucf_sink_df %>% filter(year <= config$base_year)
years_lulucf_sink_hist <- as.character(unique(lulucf_sink_hist$year))
ghgi_subset <-
lulucf_sink_df %>% filter(proj_name == 'ghgi') %>% filter(year <= config$base_year)
proj_subset <-
lulucf_sink_df %>% filter(!proj_name == 'ghgi') %>% filter(year > config$base_year)
ghgi_subset_wide <- ghgi_subset %>% pivot_wider(names_from = year,
values_from = sum) %>% ungroup() %>% select(all_of(years_lulucf_sink_hist))
proj_subset_wide <-
proj_subset %>% pivot_wider(names_from = year,
values_from = sum)
ghgi_subset_wide_rep <-
do.call('rbind', replicate(nrow(proj_subset_wide), ghgi_subset_wide, simplify = FALSE))
value_df <- cbind(proj_subset_wide, ghgi_subset_wide_rep) %>%
select(proj_name, gas, all_of(years_lulucf_sink_hist))
View(value_df)
View(lulucf_sink_hist)
View(projections_all_sm)
View(projections_all_sm %>% filter(usproj_sector=='LULUCF Sink'))
View(lulucf_sink_df)
View(proj_subset)
View(value_df)
View(ghgi_subset_wide_rep)
View(ghgi_subset_wide)
View(proj_subset)
View(proj_subset_wide)
View(projections_all_sm)
source('packages.R')
library(targets)
library(tarchetypes)
tar_source()
View(gas_dataset)
gas_breakout_df <- gen_gas_breakout(gas_dataset,config,config$gas_order)
lulucf_sink_df <- projections_all_sm %>% ungroup() %>%
select(proj_name,gas,year,sum) %>%
filter(gas=='LULUCF Sink') %>%
filter(year %in% config$table)
years_lulucf_sink <- as.character(unique(lulucf_sink_df$year))
lulucf_sink_hist <- lulucf_sink_df %>% filter(year <= config$base_year)
years_lulucf_sink_hist <- as.character(unique(lulucf_sink_hist$year))
ghgi_subset <-
lulucf_sink_df %>% filter(proj_name == 'ghgi') %>% filter(year <= config$base_year)
proj_subset <-
lulucf_sink_df %>% filter(!proj_name == 'ghgi') %>% filter(year > config$base_year)
ghgi_subset_wide <- ghgi_subset %>% pivot_wider(names_from = year,
values_from = sum) %>% ungroup() %>% select(all_of(years_lulucf_sink_hist))
proj_subset_wide <-
proj_subset %>% pivot_wider(names_from = year,
values_from = sum)
ghgi_subset_wide_rep <-
do.call('rbind', replicate(nrow(proj_subset_wide), ghgi_subset_wide, simplify = FALSE))
value_df <- cbind(proj_subset_wide, ghgi_subset_wide_rep) %>%
select(proj_name, gas, all_of(years_lulucf_sink_hist))
View(value_df)
tar_source()
tar_load(c(projections_all_sm, config))
View(projections_all_sm)
projections_all_sm_wide <- projections_all_sm %>% pivot_wider(names_from = "year",
values_from = "sum")
View(projections_all_sm_wide)
projections_all_sm_wide <- projections_all_sm %>% filter(year %in% config$table) %>% pivot_wider(names_from = "year", values_from = "sum")
gas_summary <- projections_all_sm %>% group_by(grouping, gas) %>% summarise(gas_sum = sum(sum))
View(gas_summary)
gas_summary <- projections_all_sm %>% group_by(grouping, gas, year) %>% summarise(gas_sum = sum(sum))
tbl_historic <- gas_summary %>% filter(year %in% config$table) %>% pivot_wider(names_from = "year", values_from = "gas_sum")
View(tbl_historic)
```{r}
create_summary_table <- function(category, grouping, projections_all_sm, config) {
summary <- projections_all_sm %>% group_by(grouping, category, year) %>% summarise(gas_sum = sum(sum))
#tbl_historic <- gas_summary %>% filter(year %in% config$table) %>% pivot_wider(names_from = "year", values_from = "gas_sum")
}
summary_test <- create_summary_table('gas', 'wam', projections_all_sm, config)
summary_test <- create_summary_table(category = 'gas', 'wam', projections_all_sm, config)
category = 'gas'
grouping = 'wam'
summary <- projections_all_sm %>% group_by(grouping, category, year) %>% summarise(cat_sum = sum(sum))
summary <- projections_all_sm %>% group_by(.data[[category]], .data[[grouping]], year) %>% summarise(cat_sum = sum(sum))
summary <- projections_all_sm %>%
filter(grouping == .data[[grouping]]) %>%
group_by(.data[[category]], year) %>%
summarise(cat_sum = sum(sum))
grouping  = 'wam'
summary <- projections_all_sm %>%
filter(grouping == grouping) %>%
group_by(.data[[category]], year) %>%
summarise(cat_sum = sum(sum))
View(summary)
create_summary_table <- function(category, grouping, projections_all_sm, config) {
summary <- projections_all_sm %>%
filter(grouping == grouping) %>%
group_by(.data[[category]], year) %>%
summarise(cat_sum = sum(sum))
#tbl_historic <- gas_summary %>% filter(year %in% config$table) %>% pivot_wider(names_from = "year", values_from = "gas_sum")
}
wam_test <- create_summary_table('gas','wm',projections_all_sm,config)
View(wam_test)
create_summary_table <- function(category, grouping, projections_all_sm, config) {
summary <- projections_all_sm %>%
filter(grouping == grouping) %>%
group_by(proj_name,.data[[category]], year) %>%
summarise(cat_sum = sum(sum))
#tbl_historic <- gas_summary %>% filter(year %in% config$table) %>% pivot_wider(names_from = "year", values_from = "gas_sum")
}
wam_test <- create_summary_table('gas','wm',projections_all_sm,config)
View(wam_test)
create_summary_table <- function(category, grouping, projections_all_sm, config) {
summary <- projections_all_sm %>%
filter(grouping == grouping) %>%
filter(year %in% config$table) %>%
group_by(proj_name,.data[[category]], year) %>%
summarise(cat_sum = sum(sum))
#tbl_historic <- gas_summary %>% filter(year %in% config$table) %>% pivot_wider(names_from = "year", values_from = "gas_sum")
}
summary <- projections_all_sm %>%
filter(grouping == grouping) %>%
filter(year %in% config$table) %>%
group_by(proj_name,.data[[category]], year) %>%
summarise(cat_sum = sum(sum))
View(summary)
summary <- projections_all_sm %>%
filter(grouping == grouping) %>%
filter(year %in% config$table) %>%
group_by(proj_name,.data[[category]], year) %>%
summarise(cat_sum = sum(sum)) %>%
filter(!category == 'Total')
View(summary)
summary <- projections_all_sm %>%
filter(grouping == grouping) %>%
filter(year %in% config$table) %>%
group_by(proj_name,.data[[category]], year) %>%
summarise(cat_sum = sum(sum)) %>%
filter(!gas == 'Total') # WTF?? RTI fix pls usproj
category = 'usproj_sector'
summary <- projections_all_sm %>%
filter(grouping == grouping) %>%
filter(year %in% config$table) %>%
group_by(proj_name,.data[[category]], year) %>%
summarise(cat_sum = sum(sum)) %>%
filter(!gas == 'Total') # WTF?? RTI fix pls usproj
summary <- projections_all_sm %>%
filter(grouping == grouping) %>%
filter(year %in% config$table) %>%
filter(!gas == 'Total') %>%  # WTF?? RTI fix pls usproj
group_by(proj_name,.data[[category]], year) %>%
summarise(cat_sum = sum(sum))
View(summary)
summary_historic <- summary %>%
filter(year <= config$base_year)
View(summary_historic)
summary_historic <- summary %>%
filter(year <= config$base_year) %>%
pivot_wider(names_from = "year", values_from = "cat_sum")
View(summary_historic)
summary_historic <- summary %>%
filter(year <= config$base_year)
category = 'gas'
summary <- projections_all_sm %>%
rename(category = .data[[category]]) %>%
filter(grouping == grouping) %>%
filter(year %in% config$table) %>%
filter(!gas == 'Total') %>%  # WTF?? RTI fix pls usproj
group_by(proj_name,category, year) %>%
summarise(cat_sum = sum(sum))
summary <- projections_all_sm %>%
rename(category = .data[[category]]) %>%
filter(grouping == grouping) %>%
filter(year %in% config$table)
summary <- projections_all_sm %>%
filter(!gas == 'Total') %>%  # WTF?? RTI fix pls usproj
rename(category = .data[[category]]) %>%
filter(grouping == grouping) %>%
filter(year %in% config$table) %>%
group_by(proj_name,category, year) %>%
summarise(cat_sum = sum(sum))
View(summary)
summary_total_gross <- summary %>% group_by(proj_name) %>% summarise(value = sum(cat_sum))
View(summary_total_gross)
summary_total_gross <- summary %>% group_by(proj_name, year) %>% summarise(value = sum(cat_sum))
View(summary_total_gross)
summary_total_gross <- summary %>%
filter(!category == 'LULUCF Sink') %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum))
summary_total_net <- summary %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum))
View(summary_total_net)
summary_total_gross <- summary %>%
filter(!category == 'LULUCF Sink') %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
ungroup() %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value))
summary_total_gross <- summary %>%
filter(!category == 'LULUCF Sink') %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
# ungroup() %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value))
summary_total_gross <- summary %>%
filter(!category == 'LULUCF Sink') %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
# ungroup() %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year,low,high) %>%
distinct()
summary_total_gross <- summary %>%
filter(!category == 'LULUCF Sink') %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year,low,high) %>%
distinct()
summary_total_net <- summary %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year,low,high) %>%
distinct()
summary_total_net <- summary %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year,low,high) %>%
distinct() %>%
mutate(category = 'Total Net Emissions')
summary_total_net <- summary %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year,low,high) %>%
distinct() %>%
mutate(.data[[category]] = 'Total Net Emissions')
summary <- projections_all_sm %>%
filter(!gas == 'Total') %>%  # WTH?? fix pls usproj
rename(category = .data[[category]]) %>%
filter(grouping == grouping) %>%
filter(year %in% config$table) %>%
group_by(proj_name,category, year) %>%
summarise(cat_sum = sum(sum))
summary_total_gross <- summary %>%
filter(!category == 'LULUCF Sink') %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year,low,high) %>%
distinct() %>%
mutate(category = 'Total Gross Emissions')
summary_total_net <- summary %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year,low,high) %>%
distinct() %>%
mutate(category = 'Total Net Emissions')
View(summary)
View(summary)
gas = 'CH4'
gas_summary <- summary %>%
filter(category == gas)
View(gas_summary)
gas_summary <- summary %>%
filter(category == gas) %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year, low, high) %>%
distinct() %>%
mutate(category = gas)
View(gas_summary)
col_order <- c(category,year,low,high)
summary_total_gross <- summary %>%
filter(!category == 'LULUCF Sink') %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year,low,high) %>%
distinct() %>%
mutate(category = 'Total Gross Emissions') %>%
select(col_order)
col_order <- c(category,year,low,high)
col_order <- c('category','year','low','high')
summary_total_gross <- summary %>%
filter(!category == 'LULUCF Sink') %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year,low,high) %>%
distinct() %>%
mutate(category = 'Total Gross Emissions') %>%
select(col_order)
summary_total_gross <- summary %>%
filter(!category == 'LULUCF Sink') %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year,low,high) %>%
distinct() %>%
mutate(category = 'Total Gross Emissions') %>%
select(all_of(col_order))
for(gas in config$gas_order){
cat_summary <- summary %>%
filter(category == gas) %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year, low, high) %>%
distinct() %>%
mutate(category = gas) %>%
select(all_of(col_order))
processed_datasets[[gas]] <- cat_summary
}
processed_datasets <- list()
for(gas in config$gas_order){
cat_summary <- summary %>%
filter(category == gas) %>%
group_by(proj_name, year) %>%
summarise(value = sum(cat_sum)) %>%
group_by(year) %>%
mutate(low = min(value),
high = max(value)) %>%
select(year, low, high) %>%
distinct() %>%
mutate(category = gas) %>%
select(all_of(col_order))
processed_datasets[[gas]] <- cat_summary
}
summary_table_df <- bind_rows(processed_datasets)
View(summary_table_df)
